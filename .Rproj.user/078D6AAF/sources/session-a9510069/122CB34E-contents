---
title: "Google restaurant reviews in Kuala Lumpur, Petaling Jaya and Shah Alam, Malaysia"
subtitle: "Part two"
author: "AIMdata"
execute: 
  echo: false
---


```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width = 9)


library(tidyverse)
library(here)
library(janitor)
library(scales)
library(tidytext)
library(widyr)
library(ggraph)
library(patchwork)
library(kableExtra)
library(fuzzyjoin)
library(viridis)
library(textdata)
library(stringr)
library(topicmodels)

`%out%` <- Negate(`%in%`)
options(scipen = 100)
theme_set(theme_light())
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```


```{r data}

trip_kl_cuisine <- read_csv("./data/trip_kl_cuisine.csv")

google_kl_cuisine <- read_csv("./data/google_kl_cuisine.csv")

google_rating_words <- google_kl_cuisine |> 
  select(rowid, rating, review) |> 
  unnest_tokens(word, review) |> 
  # mutate(word = SnowballC::wordStem(word, language = "porter")) |> 
  anti_join(stop_words, by = "word") |>
  add_count(word, rating) 

trip_rating_words <- trip_kl_cuisine |> 
  select(rowid, review, rating) |> 
  unnest_tokens(word, review) |> 
  # mutate(word = SnowballC::wordStem(word, language = "porter")) |> 
  anti_join(stop_words, by = "word") |>
  add_count(word, rating) 

google_rating_bigrams <- google_kl_cuisine |> 
  select(rowid, rating, review, cuisine) |> 
  unnest_tokens(bigram, review, token = "ngrams", n = 2) |> 
  filter(!is.na(bigram)) |> 
  add_count(bigram) |> 
  separate(bigram, c("word1", "word2"), sep = " ") |> 
  filter(!word1 %in% stop_words$word) |> 
  filter(!word2 %in% stop_words$word) |> 
  count(word1, word2, rating, sort = TRUE) |> 
  unite(bigram, word1, word2, sep = " ") |> 
  bind_tf_idf(bigram, rating, n)
  
trip_rating_bigrams <- trip_kl_cuisine |> 
  select(rowid, rating, review, cuisine) |> 
  unnest_tokens(bigram, review, token = "ngrams", n = 2) |> 
  filter(!is.na(bigram)) |> 
  add_count(bigram) |> 
  separate(bigram, c("word1", "word2"), sep = " ") |> 
  filter(!word1 %in% stop_words$word) |> 
  filter(!word2 %in% stop_words$word) |> 
  count(word1, word2, rating, sort = TRUE) |> 
  unite(bigram, word1, word2, sep = " ") |> 
  bind_tf_idf(bigram, rating, n)  

```

## LDA


Since reviews are so heavily skewed towards 5 stars, I think we can try and break restaurants down into just two groups: "recommended" and "not recommended". Below, the per-topic-per-word probabilities of individual words have been plotted. 

```{r}
google_bigrams_dtm <- google_kl_cuisine |> 
  select(rowid, rating, review, cuisine) |> 
  unnest_tokens(bigram, review, token = "ngrams", n = 2) |> 
  filter(!is.na(bigram)) |> 
  add_count(bigram) |> 
  cast_dtm(rating, bigram, n)

google_words_dtm <- google_rating_words |> 
  cast_dtm(rating, word, n)

google_bigrams_lda <- LDA(google_bigrams_dtm, k = 5, control = list(seed = 133))

google_words_lda <- LDA(google_words_dtm, k = 2, control = list(seed = 133))

google_ratings_topics <- tidy(google_words_lda, matrix = "beta")


google_ratings_topics |> 
  group_by(topic) |> 
  slice_max(beta, n = 20) |> 
  ungroup() |> 
  arrange(topic, -beta) |> 
  ggplot(aes(x = beta, y = reorder_within(term, beta, topic), fill = topic)) + 
  geom_col() + 
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()
  
```


If service is important to you, you should search out "service" in the reviews in Google reviews (to determine where not to go) and "friendly" to see where you should go. Unfortunately, a lot of people to whom service is important are to able to acknowledge this fact about themselves. 



```{r}
google_1_dtm <- google_rating_words |> 
  filter(rating == 1) |> 
  cast_dtm(rowid, word, n)

google_1_lda <- LDA(google_1_dtm, k = 5, control = list(seed = 133))

google_1_topics <- tidy(google_words_lda, matrix = "beta")

google_1_topics |> 
  group_by(topic) |> 
  slice_max(beta, n = 15) |> 
  ungroup() |> 
  arrange(topic, -beta)

```



```{r}
google_ratings_topics |> 
  group_by(topic) |> 
  slice_max(beta, n = 15) |> 
  ungroup() |> 
  arrange(topic, -beta)

google_ratings_topics |> 
  group_by(topic) |> 
  slice_max(gamma, n = 15) |> 
  ungroup() |> 
  arrange(topic, -gamma)
```



Regarding fine dining restaurants having higher floors, with the bigram "fine dining" show up under 2-star reviews, likely because people are unwilling to give a fine dining restaurant a 1-star review. 

The most common bigrams (two words) per rating have been plotted below. Unfortunately, they're very informative. 

Within Trip Advisor, we see certain commonalities in the language used, irrespective of rating. Additionally, we see that Trip Advisor reviewers tend to pay more attention to service than Google. The bigram "dining experience" appears across all ratings. We see a lot of bigrams related to wait times ("20 minutes", "30 minutes" etc.) in one-star and two-star reviews. However, as with the bigrams in Google reviews, 

```{r fig.height=7}
trip_rating_bigrams |> 
  filter(bigram %out% c("kuala lumpur")) |> 
  mutate(rating = as.factor(rating)) |> 
  arrange(desc(n)) |> 
  group_by(rating) |> 
  slice(1:20) |> 
  ungroup() |> 
  ggplot(aes(x = n, y = reorder_within(bigram, n, rating))) + 
  geom_col(aes(fill = rating)) + 
  facet_wrap(~ rating, scales = "free") +
  scale_y_reordered() + 
  guides(fill = "none") + 
  theme(strip.background = element_rect(fill = "black")) + 
  labs(x = "Count", 
       y = "", 
       title = "Most common bigrams by rating, Trip Advisor reviews")
  
```


```{r fig.height=7}
google_rating_bigrams |> 
  mutate(rating = as.factor(rating)) |> 
  arrange(desc(n)) |> 
  group_by(rating) |> 
  slice(1:15) |> 
  ungroup() |> 
  ggplot(aes(x = n, y = reorder_within(bigram, n, rating))) + 
  geom_col(aes(fill = rating)) + 
  facet_wrap(~ rating, scales = "free") +
  scale_y_reordered() + 
  guides(fill = "none") + 
  theme(strip.background = element_rect(fill = "black")) + 
  labs(x = "Count", 
       y = "", 
       title = "Most common bigrams by rating, Google reviews")
  
```


Sentiment analysis to see if the exceptional five-star reviews can be separated out. 
Below we've plotted the sentiments (using the AFINN dictionary) of the words 
Histograms of the average sentiment per review, broken down by rating. 


```{r}

negative_nrc <- get_sentiments("nrc") |> 
  filter(sentiment %in% c("disgust", "fear", "anger", 
                          "negative", "sadness"))

nrc <- get_sentiments("nrc")

google_rating_words |> 
  inner_join(get_sentiments("afinn")) |> 
  group_by(rowid, rating) |> 
  summarise(sentiment = mean(value, na.rm = TRUE), 
            .groups = "drop") |> 
  ggplot(aes(x = sentiment)) + 
  geom_histogram() + 
  facet_wrap(~ rating, scales = "free")
  

```

Maybe redo this to make a count of reviews with each sentiment? 


Ok, NRC sentiments by word does not work, because of things like "does not disappoint" triggering sentiments like disgust and anger




## Term Frequency and Inverse Document Frequency



```{r}
bind_tf_idf(bigram, rating, n)

google_rating_words |> 
  bind_tf_idf(word, rating, n) |> 
  tidylo::bind_log_odds(word, rating, n) |> 
  distinct(rating, word, n, tf, idf, tf_idf, log_odds_weighted) |> 
  # This is not helpful since you'll always get a bunch of cuisines 
  filter(n > 150) |> 
  group_by(rating) |> 
  arrange(desc(tf_idf)) |> 
  slice_head(n = 15)
  glimpse()
```


```{r}
google_kl_cuisine |> 
  filter(str_detect(review, "clients")) |> 
  sample_n(5) |> 
  pull(review)
```




```{r fig.height=7}

google_rating_bigrams |> 
  group_by(rating) |> 
  arrange(desc(n)) |> 
  slice(1:20) |> 
  ggplot(aes(x = n, 
             y = reorder_within(str_sub(bigram, 1, 25), 
                                n, 
                                rating), 
             fill = factor(rating))) + 
  geom_col() + 
  scale_y_reordered() + 
  facet_wrap(~ rating, scales = "free") + 
  labs(title = "Most common bigrams in Google review, by rating", 
       subtitle = 'Being friendly counts for a lot.'
       ) + 
  guides(fill = "none")

```


But this isn't all that applicable to real life, since you can't search all reviews across all restaurants for keywords, you can only search for keywords within the reviews of a single restaurant. Another point in favour of Google Reviews being a marketing ploy. Not to say that marketing ploys cannot be informational, just that the information they offer is compromised. 

There is, however, one keyword search that does work. 

## "Highly recommended restaurant" (sic)

Type in "highly recommended restaurant" (sic) into Google Maps and see what you get. I got a list of some pretty good restaurants. I don't agree with every entry, but this is probably the best performance I've seen from Google Maps in a long time. 

Now, this may seem like we've somehow gamed the system, but to bring us back down to Earth, this list of highly recommended restaurants is actually still part of the game, according to Gemini: 

>When you type "highly recommend restaurant" into the search bar, Google Maps interprets those words as keywords rather than a command. Instead of looking for a specific badge, the app uses its algoritm to build a list based on several "trust signals."

>1. Keyword matching (SEO) [...] "This place is highly recommended" [...]
>2. High "Prominence" Scores. Google defines "Prominence" as how well-known or important a business is. When you ass "highly recommended" to your search, the algorithm prioritizes restaurants with: high volume of 4.5+ star ratings. Mentions on "Best Of" lists [...]. Heavy foot traffic (Google tracks how many people acturally visit the location). 
> 3. The "Top Rated" Filter. By using that specific phrase, you are essentially triggering Google's built-in Rating Filter. Google will automatically filter out businesses with low ratings (usually anything below a 4.0) [...].
>4. Machine Learning & "Your Match"[...]

Conversely, when you type in "highly recommended restaurants" or just "highly recommended", 

>the list looks different—often featuring large, swipeable photos—because Google switches from a standard "directory" mode to "Discovery Mode." Google knows that when you use words like "highly recommended," you aren't just looking for an address; you’re looking for an experience. 

So even though you get more satisfactory results, bear in mind that the Google rating has been taken into account twice: 
that it does not solely act like a keyword is likely to prevent more manipulation and SEO
You get results that are more easily manipulated and influenced i.e. upload a photo for a free ice cream. 

In these trying times, we can also 

What else can trigger *Directory mode* on Google Maps? 

```{r fig.height=7}
google_rating_words |>
  filter(n >= 10) |> 
  filter(word %out% c("shawn", "sohag", "rafat", "md", "anik", "nero", "makhani", 
                      "mir", "ak", "kl", "belal", "lauk", "marcus", "omar", "halah", 
                      "zahangir")) |> 
  arrange(desc(tf_idf)) |> 
  group_by(rating) |> 
  slice(1:20) |>
  ggplot(aes(x = tf_idf, 
             y = reorder_within(str_sub(word, 1, 25), 
                                tf_idf, 
                                rating))) + 
  geom_col() + 
  scale_y_reordered() + 
  facet_wrap(~ rating, scales = "free")
```

```{r}
google_rating_words |> 
  count(n) |> 
  arrange(desc(nn)) |> 
```


## One-star reviews by cuisine

Let's start by making use of the column we created in the previous section and look at the relationship between words in the Google reviews dataset. Below, is a network graph of 

```{r}
clean_common_foods <- function(tbl){
  tbl |> 
    mutate(review = str_replace_all(review, "Dim sum|Dim Sum|dim sum", "dimsum"), 
         review = str_replace_all(review, "Tom Yam|Tom Yum|Tom yam|Tom yum|tom yam|tom yum", "tomyum"), 
         review = str_replace_all(review, "Char Siew|Char siew|char siew", "charsiew"), 
         review = str_replace_all(review, "Hokkien mee|Hokkien Mee|hokkien mee", "hokkienmee"), 
         review = str_replace_all(review, "Roast Duck|Roast duck|roast duck", "roastduck"),
         review = str_replace_all(review, "Fried Rice|Fried rice|fried rice", "friedrice"), 
         review = str_replace_all(review, "Roast pork|roast pork|Roast Pork", "roastpork"), 
         review = str_replace_all(review, "Mee hoon|mee hoon|Bee hoon|bee hoon|Mee Hoon|Bee Hoon", "beehoon"), 
         review = str_replace_all(review, "Salted egg|salted egg", "saltedegg"), 
         review = str_replace_all(review, "Xiao long bao|xiao long bao|Xiao Long Bao", "xiaolongbao"), 
         review = str_replace_all(review, "Chicken rice|chicken rice|Chicken Rice", "chickenrice"), 
         review = str_replace_all(review, "Foreign workers|foreign workers", "foreignworkers"))
}
```

```{r}
google_chinese_1_star_network <- google_kl_cuisine |> 
  clean_common_foods() |>  
  mutate(review_id = row_number()) |> 
  filter(cuisine == "Chinese" & rating == 1) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 10) |> 
  pairwise_cor(word, review_id, sort = TRUE) |> 
  filter(correlation >= .15) |> 
  left_join(
    google_kl_cuisine |> 
      clean_common_foods() |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine == "Chinese" & rating == 1) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(str_detect(word, "[a-z]")) |> 
      add_count(word) |> 
      filter(n > 10) |> 
      pairwise_count(word, review_id, sort = TRUE), 
    by = c("item1", "item2")
  ) |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 4), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  geom_node_text(aes(label = ifelse(name %in% 
                                        c("waited", "service", "experience", 
                                          "price", "quality", "fresh", 
                                          "tasted", "disappointing"),
                                      str_to_title(name),
                                      "")), 
                 size = 3.5, 
                 alpha = .9, 
                 colour = "#00afb9", 
                 fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of One-star Chinese Restaurant Google Review Descriptions", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: maps.google.com; Ng Choon Khon")

ggsave(here("plots", "google_chinese_1_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
```

```{r}
trip_kl_cuisine |> 
  filter(rating == 1 & cuisine == "Casual Western") |> 
  filter(str_detect(review, "cold")) |> 
  filter(str_detect(review, "hot")) |> 
  sample_n(5) |> 
  pull(review)
```

"Hot" and "cold" has to do with undeprepared and/or microwaved food

```{r}
trip_casual_western_1_star_network <- trip_kl_cuisine |> 
  mutate(review_id = row_number()) |> 
  filter(cuisine == "Casual Western" & rating == 1) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 20) |> 
  pairwise_cor(word, review_id, sort = TRUE) |> 
  filter(correlation >= .18) |> 
  left_join(
    trip_kl_cuisine |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine == "Casual Western" & rating == 1) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(str_detect(word, "[a-z]")) |> 
      add_count(word) |> 
      filter(n > 20) |> 
      pairwise_count(word, review_id, sort = TRUE), 
    by = c("item1", "item2")
  ) |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 4), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  geom_node_text(aes(label = ifelse(name %in% 
                                        c("wait", "hot", "cold", 
                                          "service", "experience", "food", 
                                          "serve"),
                                    name,
                                      "")), 
                 size = 3.1, 
                 alpha = .9, 
                 colour = "#00afb9", 
                 fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of One-star Casual Western Restaurant Trip Advisor Review Descriptions", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: maps.google.com; Ng Choon Khon")

ggsave(here("plots", "trip_casual_western_1_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
```


I think you have to use bigrams, 

```{r}
trip_kl_cuisine |> 
  group_by(cuisine, rating) |> 
  summarise(count = n(), 
            .groups = "drop") |> 
  filter(rating == 1)
  
  glimpse()
```



```{r}
trip_5_star_network <- trip_rating_words |> 
  filter(rating == 5 & n > 100) |> 
  pairwise_cor(word, rowid, sort = TRUE) |> 
  left_join(
    trip_rating_words |>
      filter(rating == 5 & n > 100) |>
      pairwise_count(word, rowid, sort = TRUE), 
    by = c("item1", "item2")
  ) |> 
  filter(correlation > .2) |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 2.5), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  # geom_node_text(aes(label = ifelse(name %in% 
  #                                       c("waited", "service", "experience", 
  #                                         "price", "quality", "fresh", 
  #                                         "tasted", "disappointing"),
  #                                     str_to_title(name),
  #                                     "")), 
  #                size = 3.5, 
  #                alpha = .9, 
  #                colour = "#00afb9", 
  #                fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of Five-star Reviews on Trip Advisor", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: TripAdvisor.com; Ng Choon Khon")


ggsave(here("plots", "trip_5_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
    
```



```{r}
trip_5_star_network <- trip_kl_cuisine |> 
  mutate(review_id = row_number()) |> 
  filter( rating == 5) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(!str_detect(word, "'")) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 30) |> 
  pairwise_cor(word, review_id, sort = TRUE) |> 
  filter(correlation >= .2) |> 
  left_join(
    trip_kl_cuisine |> 
      mutate(review_id = row_number()) |> 
      filter( rating == 5) |>
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(!str_detect(word, "'")) |>
      filter(str_detect(word, "[a-z]")) |>
      add_count(word) |> 
      filter(n > 13) |> 
      pairwise_count(word, review_id, sort = TRUE), 
    by = c("item1", "item2")
  ) |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 2.5), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  # geom_node_text(aes(label = ifelse(name %in% 
  #                                       c("waited", "service", "experience", 
  #                                         "price", "quality", "fresh", 
  #                                         "tasted", "disappointing"),
  #                                     str_to_title(name),
  #                                     "")), 
  #                size = 3.5, 
  #                alpha = .9, 
  #                colour = "#00afb9", 
  #                fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of Five-star Reviews on Trip Advisor", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: TripAdvisor.com; Ng Choon Khon")


ggsave(here("plots", "trip_5_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
```


---
title: "Google restaurant reviews in Kuala Lumpur and Petaling Jaya, Malaysia"
author: "AIMdata"
format: html
toc: true
---

Data is not meant to create a tool or an app, it is meant to create information.

```{r setup}
library(tidyverse)
library(here)
library(janitor)
library(scales)
library(tidytext)
library(widyr)
library(ggraph)
library(patchwork)
library(kableExtra)
library(fuzzyjoin)
library(viridis)
library(textdata)
library(osmdata)

`%out%` <- Negate(`%in%`)
options(scipen = 100)
theme_set(theme_light())
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```

```{r data}
google_reviews <- read_csv("./data/GoogleReview_data_cleaned.csv") |> clean_names()

trip_reviews <- read_csv("./data/TripAdvisor_data_cleaned.csv") |> clean_names() |> 
  mutate(review = str_replace_all(review, "dim sum|Dim Sum|Dim sum", "dimsum"))
```

## Introduction and overview

We're looking at two different datasets of scraped data: restaurant reviews from Google and Trip Advisor in Malaysia. They were both scraped by Ng Choon Khon using the Selenium library and cleaned by him as well.

Below, we've plotted out the restaurants found in both datasets according to the number of reviews and their mean rating. Immediately, we note an unnatural pattern in the Google dataset: Selenium is limited to scraping around 300 reviews from Google. Whilst this impacts and limits the dataset, we should still make the best use of it we can: Google's official API only allows five reviews to be extracted per restaurant because data freely given to the world and the rest of humanity must be paywalled and sold back to you.

<br>

```{r fig.height=5}
google_reviews |> 
  filter(location %in% c("Petaling Jaya", "KL")) |> 
  count(restaurant) |> 
  ggplot(aes(x = n)) + 
  geom_histogram(binwidth = 1/30) + 
  # geom_freqpoly(colour = "blue", alpha = .3) +
  scale_x_log10(breaks = c(0, 10, 30, 100, 300, 1000), 
                labels = comma) + 
  labs(title = "Google reviews per restaurant", 
       subtitle = "Largely limited to 300 reviews per restaurant",
       x = "Number of reviews", 
       y = "Number of restaurants") +

trip_reviews |> 
  filter(location %in% c("Petaling Jaya", "KL")) |> 
  count(restaurant) |> 
  ggplot(aes(x = n)) + 
  geom_histogram(binwidth = 1/30) + 
  # geom_freqpoly(colour = "blue", alpha = .3) +
  scale_x_log10(breaks = c(0, 10, 30, 100, 300, 1000), 
                labels = comma) + 
  labs(title = "Trip Advisor reviews per restaurant", 
       subtitle = "No limits for number of reviews scraped",
       x = "Number of reviews", 
       y = "Number of restaurants") +

  plot_annotation(
    title = "The Trip Advisor reviews dataset has a much more natural distribution"
  )

```

<br>

Google reviews are sorted by default by "relevance", so it is also not possible to say whether the reviews picked up by Selenium were the most recent, highest quality (word count, images), or were regarded by the community or Google as useful, just that it was some combination of those factors.

As we look into these datasets, let's bear these limitations in mind: -Google dataset is not a representative sample of reviews, as many restaurants only have the first 300 most "relevant" reviews. -Both Google maps and Trip Advisor are principally English language platforms when it isn't spoken by the majority of the population. Upon a cursory inspection, there are very few reviews in Malay.\
-The price range is missing from this data. -These reviews were extracted three years ago: some of these restaurants have closed. Before we re-scrape the data and update these datasets, let's see what is of most in the existing data (which honestly was probably used to train a model to write fake reviews).

<br>

## Increasing interpretability: adding cuisine

Let's now add a column for cuisine (the code can be downloaded at the top of the page, but it was a lot of manual work) to increase interpretability and to maximise the usefulness of the data. We'll narrow down the scope to locations in the Klang Valley (KL, PJ and Shah Alam; since I'm most familiar with and most interested in this metro).

```{r buffet-fusion-lists}

trip_buffet_list <- trip_reviews |> 
  mutate(possible_buffet = ifelse(
    str_detect(review, "Buffet|buffet") | 
      str_detect(title, "Buffet|buffet") |
      str_detect(restaurant, "Buffet|buffet")
    , 1, 0), 
    count = 1) |> 
  group_by(restaurant) %>% 
  summarise(reviews = sum(count), 
            buffet_count = sum(count[possible_buffet == 1])) |> 
  arrange(desc(buffet_count)) |> 
  mutate(buffet_pc = buffet_count / reviews) |> 
  mutate_at(vars(reviews, buffet_count, buffet_pc), ~range_wna(.)) |>  
  mutate(buffet_score = (buffet_count + buffet_pc) / 2) |> 
  arrange(desc(buffet_score)) |> 
  filter(buffet_score >= .2) |> 
  pull(restaurant)

trip_fusion_list <- trip_reviews |> 
  mutate(possible_fusion = ifelse(
    str_detect(review, "Fusion|fusion") | 
      str_detect(title, "Fusion|fusion") |
      str_detect(restaurant, "Fusion|fusion")
    , 1, 0), 
    count = 1) |> 
  group_by(restaurant) %>% 
  summarise(reviews = sum(count), 
            fusion_count = sum(count[possible_fusion == 1])) |> 
  arrange(desc(fusion_count)) |> 
  mutate(fusion_pc = fusion_count / reviews) |> 
  mutate_at(vars(reviews, fusion_count, fusion_pc), ~range_wna(.)) |>  
  mutate(fusion_score = (fusion_count +  fusion_pc) / 2) |> 
  arrange(desc(fusion_score)) |> 
  filter(fusion_score >= .11) |> 
  pull(restaurant)

google_buffet_list <- google_reviews |> 
  mutate(possible_buffet = ifelse(
    str_detect(review, "Buffet|buffet") | 
      str_detect(restaurant, "Buffet|buffet")
    , 1, 0), 
    count = 1) |> 
  group_by(restaurant) %>% 
  summarise(reviews = sum(count), 
            buffet_count = sum(count[possible_buffet == 1])) |> 
  arrange(desc(buffet_count)) |> 
  mutate(buffet_pc = buffet_count / reviews) |> 
  mutate_at(vars(reviews, buffet_count, buffet_pc), ~range_wna(.)) |>  
  mutate(buffet_score = (buffet_count + buffet_pc) / 2) |> 
  arrange(desc(buffet_score)) |> 
  filter(buffet_score >= 0.1764) |> 
  pull(restaurant)

google_fusion_list <- google_reviews |>
  mutate(possible_fusion = ifelse(
    str_detect(review, "Fusion|fusion") |
      str_detect(restaurant, "Fusion|fusion")
    , 1, 0), 
    count = 1) |> 
  group_by(restaurant) %>% 
  summarise(reviews = sum(count), 
            fusion_count = sum(count[possible_fusion == 1])) |> 
  arrange(desc(fusion_count)) |> 
  mutate(fusion_pc = fusion_count / reviews) |> 
  mutate_at(vars(reviews, fusion_count, fusion_pc), ~range_wna(.)) |>  
  mutate(fusion_score = (fusion_count +  fusion_pc) / 2) |> 
  arrange(desc(fusion_score)) |> 
  filter(fusion_score >= .11) |> 
  pull(restaurant)
```

```{r reviews-cuisine-cleaning}

reviews_cuisine_cleaning <- function(tbl) {
  
  tbl |> 
    # Not a specific restaurant
    filter(restaurant %out% c("Jalan Alor", "Sham's Cooked With Love", "Hawker Stalls in Chinatown",
                              "Feast Village Starhill Gallery", "ICC Pudu", "Imbi Market", 
                              "Taste of Asia", "Thirty8 Fashion", "Happy Mansion")) |> 
    # Some cleaning 
    mutate(restaurant = str_replace(restaurant, "Birch", "Huckleberry")) |> 
    mutate(restaurant = str_replace_all(restaurant, "Passage thru'", "Passage Thru"),
           restaurant = str_replace_all(restaurant, "Gravybaby", "GravyBaby"), 
           restaurant = str_replace_all(restaurant, "Ploy", "PLOY"), 
           restaurant = ifelse(restaurant == "What Tasty Food", "WTF - What Tasty Food", restaurant),
           restaurant = ifelse(restaurant == "ATAS", "ATAS at The RuMa Hotel & Residences", restaurant), 
           restaurant = ifelse(restaurant == "Al Rawsha Restaurant Kuala Lumpur", "Al Rawsha Restaurant", restaurant), 
           restaurant = ifelse(restaurant == "Aliyaa", "Aliyaa Island Restaurant & Bar", restaurant), 
           restaurant = ifelse(restaurant == "Arthur's Bar & Grill, Shangri-La Hotel, Kuala Lumpur", 
                               "Arthur's Bar & Grill", restaurant), 
           restaurant = ifelse(str_detect(restaurant, "Lemon Garden"), 
                               "Lemon Garden", 
                               restaurant), 
           restaurant = ifelse(str_detect(restaurant, "Din Tai Fung at The Gardens Mall"),
                               "Din Tai Fung at The Gardens Mall", 
                               restaurant), 
           restaurant = ifelse(restaurant == "Monnalisa Italian Restaurant", 
                               "Monnalisa Ristorante Italiano", 
                               restaurant), 
           restaurant = ifelse(str_detect(restaurant, "Fatty Mee Hoon Kuih"), 
                               "Fatty Mee Hoon Kuih", 
                               restaurant), 
           restaurant = ifelse(str_detect(restaurant, "Whisky Bar KL"), 
                               "The Whisky Bar", 
                               restaurant), 
           restaurant = str_replace_all(restaurant, "W XYZ", "WXYZ"), 
           restaurant = ifelse(restaurant == "The Daily Grind Bangsar", 
                               "The Daily Grind", 
                               restaurant), 
           restaurant = ifelse(restaurant == "Chili's 1 Utama", "Chili's", restaurant), 
           restaurant = str_replace_all(restaurant, "Merini", "Marini"))  |>
    mutate(
      cuisine = case_when(
        
        # The order of the case_when statements is important. Particularly, it should go
        # South Asian -> Buffet -> Fusion,
        # This is because I would consider South Asian buffet restaurants as South Asian.
        # And I would not consider hotel buffets to be a type of fusion restaurant, 
        # despite all the types of food they might serve.
        # Also, Grill before Bar.
        
          str_detect(
          restaurant,
          "Grill|Steakhouse|Grub|Steak|Brasserie|steakhouse|BBQ|Rock Salt Restaurant|BBP|Churrascaria|Marble 8|Beast|Nando's|Nandos|Bar B Q|Down to Bones|Barbecue|Vantador|Bbq|Butcher Carey|PRIME|Brasserie|Karnivormalaya|Chamber's"
        ) ~ "Grill",
          str_detect(restaurant,
          "Bistro|Deli|Secret Recipe|Tujo|Wild Sheep|Antipodean|Coffee|One Half|Blue Room|Awesome Canteen|Botanica|Chili's|Don's Diner|GravyBaby|Hornbill|Huck's|myBurgerLab|Naj & Belle|Tony Roma's|Louisiana|Cor Blimey|4Fingers|Bacon And Balls|POP PIZZA|After Black|Ashley's by Living Food|March Azalea Kitchen|Mighty Monster IPC|Sköhns Canteen|Table9|Rabbit Hole|Williams Corner|Tiki Taka|4 Fingers|Ben's|Souled Out|Suzi's Corner|Fuel Shack Signature|SOULed OUT|TGI Friday|Chilli's|Pigs & Wolf|Ship|Breakfast Thieves|Ante|Morganfield's|Subway|Meat The Porkers|Pan & Tamper|Hubba Mont Kiara|Bacon & Balls|Tate|Gin Ger|Fuel Shack|Jarrod & Rawlins|BreadFruits|Glass Tartines and Tipples|B-Lab|Mighty Monster|Ticklish Ribs|Cozy Corner|Duddha|Fat Brother|Define:food|Tangerine|Sausage & Ribs Shack|Texas Chicken|Coco Fika|Andra By Gula Cakery|D Place|Chef Zubir|Hubz|Maipi Corner|Marrybrown|Meet and Meat|Jibby & Co|Midwest|WhupWhup|Foodilicious Kitchen Shah Alam|Craveat"
        ) ~ "Casual Western",
        str_detect(
          restaurant,
          "Chinese|Taiwan|[\\p{Han}]|Nam Heong|Dynasty|Putien|Hoi|Gold Dragon|Han Room|Village Duck|Village Roast Duck|Unique|Steamboat|Ah |Roast Pork|Hokkien Mee|Dim Sum|Lai Po Heen|Yun House|Chynna|Li Yen|Shanghai|Lai Foong|Little Penang Kafé|Goon Wah|Shang Palace|YEN|Yut Kee|Din Tai Fung|Dragon-i|Celestial Court|The Ming Room|Sai Woo|Luk Yu|Yue|Way Modern Chinois|Hong Kong|Blue Boy Vegetarian Food Centre|Xin|Lai Ching Yuen|Noble House|Noodle House|Bak Kut|Fong Lye|Wan Tan Mee|Sarawak Laksa|Hakka|Ruyi & Lyn|Chicken rice|Chicken Rice|Char Siew|Siew Yoke|Dim Sum|Chiu Chow|Hainan|Hailam|Pork Noodles|Koong Woh Tong|Yong Tow Foo|Madam Tang| Kee|The Pot KL|Yu Noodle Cuisine|Wan Chun Ting|Muk Koot|Oversea|Marco Polo|Cu Cha Restaurant|Imperial|Grand Harbour|In Colonial Restaurant|Museum Restaurant|Heng|Hiong Kong|Ban Lee Restaurant|Heong|Restaurant Mama Love|Hee Lai Ton|New Paris|Kingdom Palace|Siu Siu|Sam You|Ti Chen|Mee Hoon|Fishball|Peoh|Esquire|Restourant Boston|7th Mile Kitchen"
        ) ~ "Chinese",
        str_detect(
          restaurant,
          "Italia|Olive|Ristorante|Osteria|Prego|Pizza|Trattoria|Nero Nero|Positano|a'Roma|Vin's Restaurant|Michelangelo|Marini's|Nizza|Porto Romano|Tatto|Neroteca|La Risata|Portofino|Ciao|Enoteca|Mangiare|Sassolino|Pizzeria|La Casa Restaurant & Patisserie|Favola|Senja Restaurant|Graze"
        ) ~ "Italian",
        str_detect(
          restaurant,
          "German|French|Chez|Marta's|Tapas|Bistro à Table|Iberico|El Toro Loco|Petit|Mercat|Dominic|El Cerdo|Quivo|Skillet KL|iberico|Yeast|Maison Francaise|El Mesón|Lafite|Topshelf|Wurst|Sabayon|Chateau|Naughty Babe Dirty Duck|Hit & Mrs|Le Gourmandin|Soleil|Suisse|IKEA|Leonardo|MARCO Creative Cuisine|Abanico|La Belle Saison"
        ) ~ "European",
        str_detect(restaurant, "Thai|Bangkok|BKK|Baan|Tamarind Springs|Chakri|BAAN|Samira by Asian Terrace|Ekkamai|Busaba|Mamasan|Krung Thep|Tomyam|Aroma Restaurant|Chef Korn|Tuk Tuk"
                   ) ~ "Thai",
        str_detect(restaurant, "Arab|Turkish|Al-|Halab|Egyptian|Tarbush|Wadi|Sahara Tent|Shawarma|Damascus|Syria|Hadramawt|diafah|Iraq|Sarifa|Al Rawsha|The Castle Restaurant|Saba Restaurant|Marhaba|ALRAWSHA Restaurant|Antara|Andalus|El Sham|Oregi Restaurant"
                   ) ~ "Levantine",
        # Malay (Chef Wan) and Malaysian (Madan Kwan's)
        str_detect(
          restaurant,
          "Malay|Rasa|Cik|Dapur|Rebung|Zakhir|Village Park|ADU|Warisan|Nasi|Dancing Fish|Sarang|Bijan|Serai|Sambal|ATAS|Grandmama's|Onde Onde|JP teres|Satay Station|Chef Wan|De.Wan|Siti Li Dining|Pintu|Ramly|Penyet|Sepiring|Satay|Restoran Ali Food Corner|Open House|Sup Utara|Bawal Power|Ikan|Gulai|Kampung Mu|Marlina Station|Wong Solo|Bawang|Goreng"
        ) ~ "Malay",
        str_detect(
          restaurant,
          "Nonya|Baba|Mum's Place|Madam Kwan|Chuup|Old China Cafe|Nyonya|Little Penang|Oriental Cravings|Papparich|Uncle Don|Muar Restaurant|Kumi|Peranakan|1919 Restaurant"
        ) ~ "Malaysian",
        str_detect(
          restaurant,
          "Japan|Edo|Sushi|Kampachi|Iketeru|Menya|Nobu|Omakase|TOKYO|Tokyo|Tonkatsu|Udon|Soba|Ichibanya|Maruhi|Omulab|Zipangu|Miyabi|Izakaya Hanazen|hokkaido|Senya|IPPUDO|Umai-Ya|Ichiban|Yakiniku|Nihon|Lucky Tora|Hokkaido|Mo-Mo Paradise|Sushi|sushi|Uokatsu|Ramen|Tempura|Izakaya|Tokyo|Kyoto|Oishii|Gyoza|Ichiban|Tonkotsu|Tonkatsu|Sakura|Yakitori|Kyush|Teppanyaki|Taka|Kikubari|Ichiyutei|Enju|Okonomi|Toridoki|Syokudo|Tsukiji|Yuzu|Madam Salma|Fu-Rin"
        ) ~ "Japanese",
        # Why not merge all Korean BBQ into grill?
        str_detect(
          restaurant,
          "Filipino|Bali|Vietnam|GOODDAM|Korea|Sao Nam|Naughty Nuri's|KyoChon|Viet|Dakgalbi|Sopoong|Kung Jung|Saigon|Sae Ma Eul|KoRyo-Won|Koryowon|Persia|Astana|Buns & Noodles|Kyochon|Topokki"
        ) ~ "Other Asian",
        
        # Do not str_detect(.x, "bar")
        str_detect(restaurant, "Whisky|Lounge|Bar|Decanter|Knowhere Bangsar|The Locker & Loft|Tom, Dick & Harry's|WET|The Enclave|Out of Africa|Opium|THIRTY8|Healy Mac's|TEMPTationS|Loco bar|La Bodega|Vertigo|The Social|No Black Tie|The BAR|O'Galito|Table 23|D Legends bar|Bobo KL|Rock Bottom|twenty-one kitchen+bar|Bentley's Pub|Vinh City Entertainment|twenty-one|Malones|White Horse Tavern|Supperclub KL|Backyard|The Ceylon bar|W1 Dining & Cocktails|Splash|Drop Exchange|Boardwalk|Deep Blue|The Sticky Wicket|OneSixFive|The Attic|Concubine KL|The Green Man|THE BAR|Marini’s on 57|Rooftop 25"
        ) ~ "Bar",
        str_detect(restaurant, "Cafe|Grind|Café|Tujo|cafe|Alexis|The Loaf|Yellow Brick Road|Huckleberry|TWG|Newens Tea House|Miss Ellie Tea House|Frisky Goat|Urbean|Ra-Ft|Backofen|STG Bukit Ceylon|VCR|Rise & Shine by Tapestry|Kafe|Kaffe|Kopi|Latte|Kopitiam"
        ) ~ "Cafe",
        str_detect(
          restaurant,
          "Kerala|India|Lanka|Malabar|Curry|Raju|Bhavan|Thosai|Tandoor|Bombay|Gem Restaurant|Nasi Kandar|NADODI|Qureshi|RSMY|Sangeetha|Nirwana|Asian Rice Pot|Masala|Annalakshmi|Aliyaa|MTR|Devi's Corner|WTF - What Tasty Food|Nadodi|Delhi Royale|FLOUR|Bakti Woodlands|Vishal Food|Banana Leaf|Hyderabad|sarvana bhavan|Spice Garden|Roti|TasteBud|Chapati|Pakistani|Jai Hind|BananaBro|Naan|SK Corner|Sri Paandi|Majapahit|Nan |GinRikSha|Briyani|Biryani|Maju Palace|Seetharam|Havelly|Punjab|Goa By Sapna Anand|Swaadisht|Mamak|Sri|Chapathi|Moghul|Rani|Aryan|Yarl|Sagar|ABC Foods Corner|Sheesh Mahal|Mallikas"
        ) ~ "South Asian",
        
        # Buffet list
        restaurant %in% trip_buffet_list ~ "Buffet",
        restaurant %in% google_buffet_list ~ "Buffet", 
        str_detect(restaurant, "Flock, W Kuala Lumpur|HYdeout By Grand Hyatt Kuala Lumpur|Curate"
                   ) ~ "Buffet", 
        # List of fusion restaurants
        restaurant %in% trip_fusion_list ~ "Fusion",
        restaurant %in% google_fusion_list ~ "Fusion", 
        str_detect(restaurant, "Symphony by Chef Jo|Darren Chin|Dewakan|DC Restaurant|Sitka|Ginger Restaurant|Table & Apron|Foodsbury"
                   ) ~ "Fusion", 
        
        # Unfortunate, there aren't enough Latino restaurants for their own category
        str_detect(restaurant, "Latino|Mexican|Carretas|Mexico|Frontera|Mexicana|Cocina"
        ) ~ "Other",
        str_detect(restaurant, "Oliver Gourmet|Seafood|Shell Out|BAIT|Fisherman|Fish & Co|Shucked|Delay No More Crab Restaurant|Ombak"
        ) ~ "Seafood",
        str_detect(restaurant, "Vasco's|Latest Recipe|Lemon Garden|Prime|Gastro Sentral|Chinoz On The Park|Shook|Plane In The City|Contango|The Living Room|Curate At Four Seasons|Beta KL|CEDAR on 15|The Apartment|The Grand Getaway|Strato|Ril's|Chocha|Wizards at Tribeca|Nipah|Joloko|Leonardo's Dining Room & Wine Loft|Roofino Skydining|Troika|Dining In The Dark KL|PLOY|Atlas Gourmet Market|WIP|Nathalie Gourmet Studio|Altitude|The Canteen by Chef Adu|Latitude 03|The Orchid Conservatory|Graze Restaurant|Zende Restaurant|Crystal|Cielo KL|Cedar On 15"
        ) ~ "Other Upmarket",
        # Just mopping up all the Dai Chow
        # I feel this is going to create problems down the line
        str_detect(restaurant, "Restoran"
        ) ~ "Chinese",
        TRUE ~ "Other"
  )) |> 
    mutate(rowid = row_number())
}


```

```{r trip-kl-cuisine and google-kl-cuisine}
trip_kl_cuisine <- trip_reviews |> 
  filter(location %in% c("KL", "Petaling Jaya", "Shah Alam")) |> 
  reviews_cuisine_cleaning() 

google_kl_cuisine <- google_reviews |> 
  filter(location %in% c("KL", "Petaling Jaya", "Shah Alam")) |> 
  reviews_cuisine_cleaning()

summary_stats <- rbind(
trip_kl_cuisine |>
  mutate(count = 1) |> 
  group_by(restaurant) |> 
  mutate(reviews = sum(count)) |> 
  ungroup() |> 
  filter(reviews >= 20) |> 
  summarise(mean_rating = mean(rating), 
            median_rating = median(rating), 
            mode_rating = Mode(rating)) |> 
  mutate(source = "Trip Advisor"),

google_kl_cuisine |>
  mutate(count = 1) |> 
  group_by(restaurant) |> 
  mutate(reviews = sum(count)) |> 
  ungroup() |> 
  filter(reviews >= 20) |> 
  summarise(mean_rating = mean(rating), 
            median_rating = median(rating),
            mode_rating = Mode(rating)) |> 
  mutate(source = "Google")
)
```

Determining the cuisine of a restaurant should be fairly obvious in most cases. Additional notes on the coding of these cuisines may be found in the appendices.

Let's take a look at an overview of both datasets with cuisines included. From the plot below, we see that:

-   South Asian, Chinese, Casual Western, Japanese and Bars are the most commonly-reviewed (and the most common?) restaurants in the Klang Valley.\
-   Chinese, Casual Western, Malaysian and Thai are the lowest-rated cuisines.
-   Fusion, Other Upmarket (experiential dining or unspecified "international" cuisine) and bars have the highest ratings, with 60% or more of all reviews being five stars.
-   Trip Advisor and Google reviewers differ the most on their opinions of Levantine, Casual Western and Japanese cuisine.

<br>

```{r}
google_kl_cuisine |> 
  mutate(count = 1) |> 
  group_by(cuisine) |> 
  summarise(reviews = n(), 
            five_star_reviews = sum(count[rating == 5]), 
            mean_rating = mean(rating)) |> 
  mutate(five_star_pc = five_star_reviews / reviews, 
         source = "Google")|> 
  select(five_star_pc, cuisine, source, reviews, mean_rating) |> 
  rbind(
    trip_kl_cuisine |> 
      mutate(count = 1) |> 
      group_by(cuisine) |> 
      summarise(reviews = n(), 
                five_star_reviews = sum(count[rating == 5]), 
                mean_rating = mean(rating)) |> 
      mutate(five_star_pc = five_star_reviews / reviews, 
             source = "Trip Advisor") |> 
      select(cuisine, five_star_pc, source, reviews, mean_rating)
  ) |> 
  ggplot(aes(x = five_star_pc, 
             y = fct_reorder(cuisine, mean_rating), 
             fill = mean_rating)) + 
  geom_col(alpha = .7) + 
  scale_x_continuous(labels = percent) +
  geom_text(aes(label = comma(reviews)), 
            position = position_dodge(width = .9), 
            hjust = "inward", 
            colour = "grey20") + 
  scale_fill_viridis(direction = -1, begin = .15, option = "turbo") +
  facet_wrap(~ source) + 
  guides(fill = "none") + 
  theme(strip.background = element_rect(fill = "black"), 
        strip.text = element_text(face = "bold")) +
  labs(x = "% of reviews that are five-stars", 
       y = "", 
       title = "Mean rating of restaurants on Google and Trip Advisor, by cuisine", 
       subtitle = "Only restaurants in the Klang Valley. Total number of reviews in black.")
  

```

<br>

With reference to the scatterplots below, that ratings are skewed towards the higher end: the mean rating of restaurants on Google is **`r summary_stats |> filter(source == "Google") |> pull(mean_rating) |> round(2)`** and the mean rating on Trip Advisor is **`r summary_stats |> filter(source == "Trip Advisor") |> pull(mean_rating) |> round(2)`**. The median and mode for both datasets is **5**. This means that the median rating for a restaurant will likely provide a better centre for the data as the mean can be pulled down significantly by outlier low-starred reviews.

For both restaurants in Trip Advisor and Google, the higher the number of reviews, the higher the mean rating. Maybe popularity is an indicator of excellence? In food, at least.

<br>

```{r restaurant-comparison-trip-google, fig.width=7, warning=FALSE, message=FALSE}

compare_google_trip <- function(tbl){
  
  tbl |> 
    group_by(restaurant, cuisine) |> 
    summarise(reviews = n(), 
              mean_rating = mean(rating), 
              median_rating = median(rating), 
              mode_rating = Mode(rating),
              .groups = "drop") |>  
    filter(reviews >= 20)
  }

plot_google_trip <- function(tbl){
  
  tbl |> 
    ggplot(aes(x = reviews, 
               y = mean_rating)) +
    geom_point(aes(colour = median_rating), 
               alpha = .4) + 
    # scale_size_continuous(limits = c(1, 10)) +
    scale_x_log10() +
    scale_colour_viridis(option = "turbo", begin = .15, end = .9, direction = -1, 
                         labels = label_number(accuracy = .1)) +
    # ggrepel::geom_text_repel(aes(label = cuisine)) + 
    geom_smooth(method = "lm", alpha = .1, size = 0, span = .5) + 
    geom_smooth(method = "lm", se = FALSE, alpha = .1, size = .2) + 
    labs(subtitle = "Restaurants with less than 20 reviews excluded", 
         x = "Number of reviews",
         y = "Mean Rating",
         colour = "Median Rating") +
    theme(legend.title = element_text(size = 9), 
          legend.text = element_text(size = 7),
          legend.key.size = unit(0.9, "lines"))
    
}
  

google_kl_cuisine |> 
  compare_google_trip() |> 
  plot_google_trip() + 
  # ylim(3.8, 4.6) +
  labs(title = "Google reviews") +
  guides(size = guide_legend(override.aes = list(alpha = 1))) +

trip_kl_cuisine |> 
  compare_google_trip() |> 
  plot_google_trip() + 
  # ylim(3.8, 4.6) +
  labs(title = "Trip Advisor reviews") +
  guides(size = "none") +
  
  plot_annotation(title = "Klang Valley restaurants and average ratings") +
  plot_layout(guides = "collect") & theme(legend.position = "bottom")

ggsave("./plots/cuisine_comparison_trip_google.png", height = 7, width = 11, units = "in")

```

<br>

Just having these two sets of reviews to examine,

Are reviews useful? The commonality of five-star reviews indicate that the mean rating is more likely an indicator of expectations being met rather than any true excellence.

<br>

<br>

We will look at the different userbases of Google and Trip Advisor in a later section.

<br><br><br>

## In both Google and Trip

These differences probably come down to the reviewers on Google and Trip Advisor and their respective purposes. Google reviewers are often locals or general consumers, whilst Trip Advisor reviewers tend to be travellers who have to provide more structured, specific reviews, leading to less casual reviews as there is a minimum word count required.

```{r restaurant-fuzzy-match}

restaurant_fuzzy_match <- stringdist_join(
  trip_reviews |> 
    filter(location %in% c("KL", "Petaling Jaya", "Shah Alam")) |> 
    distinct(restaurant) |> 
    mutate(restaurant_match = str_remove_all(restaurant, "Restaurant|Cuisine|restaurant|Restoran|Curry House|Japanese"), 
           restaurant_match = trimws(restaurant_match)) |> 
    select(restaurant_trip = restaurant, 
           restaurant_match), 
  google_kl_cuisine |> filter(location %in% c("KL", "Petaling Jaya", "Shah Alam")) |> 
    distinct(restaurant)|> 
    mutate(restaurant_match = str_remove_all(restaurant, "Restaurant|Cuisine|restaurant|Restoran|Curry House|Japanese"),
           restaurant_match = trimws(restaurant_match)) |> 
    select(restaurant_google = restaurant, 
           restaurant_match), 
  by = "restaurant_match", 
  ignore_case = TRUE, 
  method = "jw",
  max_dist = 99, 
  distance_col = "dist"
) |> 
  group_by(restaurant_match.x) |> 
  slice_min(order_by = dist, n = 1) |> 
  arrange((dist)) |> 
  select(match_x = restaurant_match.x, 
         match_y = restaurant_match.y, 
         dist,
         restaurant_google, 
         restaurant_trip) |>
  ungroup()

both_google_and_trip <- restaurant_fuzzy_match |> 
  filter(match_x != "Teh Laris Cafe" | match_y != "Thosai Cafe") |> 
  filter(match_x != "The Ming Room" | match_y != "The Living Room") |>
  filter(match_x != "Cilantro & Wine Bar" | match_y != "ZENZERO & Wine Bar") |> 
  filter(match_x != "Kedai Kopi Pak Ngah" | match_y != "Kedai Kopi Lai Foong") |> 
  filter(match_x != "Shanghai" | match_y != "Old Shanghai") |> 
  filter(match_x != "Ah Ni Bak Kut Teh" | match_y != "Ah Sang Bak Kut Teh") |> 
  filter(match_x != "Pin Wei Seafood" | match_y != "Hoi Peng Seafood") |> 
  filter(match_x != "Cafe Cafe" | match_y != "Cafe ETC") |> 
  filter(match_x != "Tao Chinese" | match_y != "Ee Chinese") |>
  filter(match_x != "Seoul Garden" | match_y != "Lemon Garden") |>
  filter(match_x != "De.Wan" | match_y != "Dewakan") |>
  filter(dist <= 0.16666667)

combined_google_trip <- trip_kl_cuisine |> 
  filter(restaurant %in% both_google_and_trip$restaurant_trip) |> 
  select(cuisine, location, restaurant, rating, review) |>
  mutate(source = "TripAdvisor") |> 
  rbind(
    google_kl_cuisine |> 
      filter(restaurant %in% both_google_and_trip$restaurant_google) |> 
      select(cuisine, location, restaurant, rating, review) |> 
      mutate(source = "Google")
  ) |> 
  mutate(row_id = row_number()) |> 
  left_join(
    both_google_and_trip |> 
      distinct(restaurant_google, restaurant_trip) |>
      rename(restaurant = restaurant_trip),
    by = c("restaurant")
  ) |> 
  left_join(
    both_google_and_trip |> 
      distinct(restaurant_google, restaurant_trip) |>
      rename(restaurant = restaurant_google),
    by = c("restaurant")
  ) |> 
  mutate(restaurant_new = ifelse(!is.na(restaurant_google), 
                                 restaurant_google, 
                                 restaurant)) |> 
  group_by(row_id, location, cuisine, restaurant = restaurant_new, review, source) |> 
  summarise(rating = mean(rating), 
            .groups = "drop") |> 
  mutate(restaurant = trimws(restaurant))

```

```{r common-restaurants}
combined_google_trip |> 
  group_by(restaurant, source) |> 
  summarise(rating = mean(rating), 
          .groups = "drop") |> 
  pivot_wider(names_from = source, 
              values_from = rating) |> 
  left_join(
    combined_google_trip |> 
      count(restaurant, 
            name = "count"), 
    by = "restaurant"
  ) |> 
  left_join(
    combined_google_trip |> 
      distinct(restaurant, cuisine), 
    by = "restaurant"
  ) |> 
  filter(!is.na(Google) & !is.na(TripAdvisor)) |> 
  ggplot(aes(x = Google, y = TripAdvisor)) + 
  geom_point(aes(colour = cuisine, 
                 size = count)) + 
  scale_colour_viridis_d(option = "turbo") +
  ggrepel::geom_text_repel(aes(label = restaurant), 
                           size = 1.2) + 
  labs(title = "Comparison between Google and TripAdvisor restaurant ratings", 
       subtitle = "Size indicates number of reviews", 
       y = "Trip Advisor mean rating", 
       x = "Google mean rating", 
       colour = "Cuisine", 
       size = "Review count") + 
  # guides(colour = guide_legend(override.aes = list(size = .7))) +
  theme(legend.title = element_text(size = 6), 
        legend.text = element_text(size = 6), 
        legend.key.size = unit(0.3, "lines"))

ggsave("./plots/restaurant_comparison_trip_google.png", height = 7, width = 11, units = "in")  
```

<br>

Google and TripAdvisor users seem to agree more than disagree. Five-star

It's possible that reviews are useless.

Good service and environment can prevent a one-star review. Humans are crazy and feel debts viscerally. Separate food from service and waiters? But restaurants don't do that. Dining is an experience, and all aspects of the experience are vital.

```{r}
google_kl_cuisine |> 
  filter(str_detect(review, "zahangir")) |> 
  pull(review)
```

Maybe there should be separate scores for the food and the service? How do

## Words

```{r fig.height=7}

google_rating_words <- google_kl_cuisine |> 
  select(rowid, review) |> 
  unnest_tokens(word, review) |> 
  # mutate(word = SnowballC::wordStem(word, language = "porter")) |> 
  anti_join(stop_words, by = "word") |>
  count(word, rating, sort = TRUE) |> 
  bind_tf_idf(rating, word, n) |> 
  tidylo::bind_log_odds(rating, word, n)

trip_rating_words <- trip_kl_cuisine |> 
  select(review, rating) |> 
  unnest_tokens(word, review) |> 
  # mutate(word = SnowballC::wordStem(word, language = "porter")) |> 
  anti_join(stop_words, by = "word") |>
  count(word, rating, sort = TRUE) |> 
  bind_tf_idf(rating, word, n) |> 
  tidylo::bind_log_odds(rating, word, n)


```

```{r fig.height=7}
trip_rating_words |> 
  filter(n >= 20) |> 
  filter(word %out% c("monk3yseendo")) |> 
  arrange(desc(log_odds_weighted)) |> 
  group_by(rating) |> 
  slice(1:20) |>
  ggplot(aes(x = log_odds_weighted, 
             y = reorder_within(str_sub(word, 1, 25), 
                                log_odds_weighted, 
                                rating))) + 
  geom_col() + 
  scale_y_reordered() + 
  facet_wrap(~ rating, scales = "free")
```

```{r fig.height=7}
google_rating_words |> 
  filter(n >= 20) |>  
  arrange(desc(log_odds_weighted)) |> 
  group_by(rating) |> 
  slice(1:20) |>
  ggplot(aes(x = log_odds_weighted, 
             y = reorder_within(str_sub(word, 1, 25), 
                                log_odds_weighted, 
                                rating))) + 
  geom_col() + 
  scale_y_reordered() + 
  facet_wrap(~ rating, scales = "free")
```

```{r fig.height=7}
trip_rating_words |> 
  filter(n >= 20) |>  
  filter(word %out% c("forward.packaging", "lunch.the")) |> 
  arrange(desc(tf_idf)) |> 
  group_by(rating) |> 
  slice(1:20) |>
  ggplot(aes(x = tf_idf, 
             y = reorder_within(str_sub(word, 1, 25), 
                                tf_idf, 
                                rating))) + 
  geom_col() + 
  scale_y_reordered() + 
  facet_wrap(~ rating, scales = "free")
```

```{r fig.height=7}
google_rating_words |>
  filter(n >= 10) |> 
  filter(word %out% c("shawn", "sohag", "rafat", "md", "anik", "nero", "makhani", 
                      "mir", "ak", "kl", "belal", "lauk", "marcus", "omar", "halah", 
                      "zahangir")) |> 
  arrange(desc(tf_idf)) |> 
  group_by(rating) |> 
  slice(1:20) |>
  ggplot(aes(x = tf_idf, 
             y = reorder_within(str_sub(word, 1, 25), 
                                tf_idf, 
                                rating))) + 
  geom_col() + 
  scale_y_reordered() + 
  facet_wrap(~ rating, scales = "free")
```

```{r}
google_rating_words |> 
  count(n) |> 
  arrange(desc(nn)) |> 
```

<br><br><br>

## One-star reviews

Let us investigate Chinese restaurants Casual Western Bars

```{r}
google_one_star_words <- google_kl_cuisine |> 
  mutate(review = str_replace_all(review, "Dim sum|Dim Sum|dim sum", "dimsum"), 
         review = str_replace_all(review, "Tom Yam|Tom Yum|Tom yam|Tom yum|tom yam|tom yum", "tomyum"), 
         review = str_replace_all(review, "Char Siew|Char siew|char siew", "charsiew"), 
         review = str_replace_all(review, "Hokkien mee|Hokkien Mee|hokkien mee", "hokkienmee"), 
         review = str_replace_all(review, "Roast Duck|Roast duck|roast duck", "roastduck"),
         review = str_replace_all(review, "Fried Rice|Fried rice|fried rice", "friedrice"), 
         review = str_replace_all(review, "Roast pork|roast pork|Roast Pork", "roastpork")) |> 
  mutate(review_id = row_number()) |> 
  filter(cuisine %in% c("Thai", "Chinese","Japanese") & rating == 1) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 15) |> 
  pairwise_cor(word, review_id, sort = TRUE) |> 
  filter(correlation >= .15) |> 
  left_join(
    google_kl_cuisine |>
      mutate(review = str_replace_all(review, "Dim sum|Dim Sum|dim sum", "dimsum"), 
         review = str_replace_all(review, "Tom Yam|Tom Yum|Tom yam|Tom yum|tom yam|tom yum", "tomyum"), 
         review = str_replace_all(review, "Char Siew|Char siew|char siew", "charsiew"), 
         review = str_replace_all(review, "Hokkien mee|Hokkien Mee|hokkien mee", "hokkienmee"), 
         review = str_replace_all(review, "Roast Duck|Roast duck|roast duck", "roastduck"),
         review = str_replace_all(review, "Fried Rice|Fried rice|fried rice", "friedrice"), 
         review = str_replace_all(review, "Roast pork|roast pork|Roast Pork", "roastpork")) |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine %in% c("Thai", "Chinese","Japanese") & rating == 1) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(str_detect(word, "[a-z]")) |> 
      add_count(word) |> 
      filter(n > 15) |> 
      pairwise_count(word, review_id, sort = TRUE), 
    by = c("item1", "item2")
  ) 

google_one_star_network_graph <- google_one_star_words |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 2.5), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  geom_node_text(aes(label = ifelse(name %in% 
                                        c("waited", "service", "experience", 
                                          "price", "quality", "fresh", 
                                          "tasted", "disappointing"),
                                      str_to_title(name),
                                      "")), 
                 size = 3.5, 
                 alpha = .9, 
                 colour = "#00afb9", 
                 fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of One-star Chinese Restaurant Review Descriptions", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: maps.google.com; Ng Choon Khon")

ggsave(here("plots", "google_1_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
```

```{r}
clean_common_foods <- function(tbl){
  tbl |> 
    mutate(review = str_replace_all(review, "Dim sum|Dim Sum|dim sum", "dimsum"), 
         review = str_replace_all(review, "Tom Yam|Tom Yum|Tom yam|Tom yum|tom yam|tom yum", "tomyum"), 
         review = str_replace_all(review, "Char Siew|Char siew|char siew", "charsiew"), 
         review = str_replace_all(review, "Hokkien mee|Hokkien Mee|hokkien mee", "hokkienmee"), 
         review = str_replace_all(review, "Roast Duck|Roast duck|roast duck", "roastduck"),
         review = str_replace_all(review, "Fried Rice|Fried rice|fried rice", "friedrice"), 
         review = str_replace_all(review, "Roast pork|roast pork|Roast Pork", "roastpork"), 
         review = str_replace_all(review, "Mee hoon|mee hoon|Bee hoon|bee hoon|Mee Hoon|Bee Hoon", "beehoon"), 
         review = str_replace_all(review, "Salted egg|salted egg", "saltedegg"), 
         review = str_replace_all(review, "Xiao long bao|xiao long bao|Xiao Long Bao", "xiaolongbao"), 
         review = str_replace_all(review, "Chicken rice|chicken rice|Chicken Rice", "chickenrice"), 
         review = str_replace_all(review, "Foreign workers|foreign workers", "foreignworkers"))
}
```

```{r}

google_chinese_1_star_network <- google_kl_cuisine |> 
  clean_common_foods() |>  
  mutate(review_id = row_number()) |> 
  filter(cuisine == "Chinese" & rating == 1) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 10) |> 
  pairwise_cor(word, review_id, sort = TRUE) |> 
  filter(correlation >= .15) |> 
  left_join(
    google_kl_cuisine |> 
      clean_common_foods() |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine == "Chinese" & rating == 1) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(str_detect(word, "[a-z]")) |> 
      add_count(word) |> 
      filter(n > 10) |> 
      pairwise_count(word, review_id, sort = TRUE), 
    by = c("item1", "item2")
  ) |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 2.5), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  geom_node_text(aes(label = ifelse(name %in% 
                                        c("waited", "service", "experience", 
                                          "price", "quality", "fresh", 
                                          "tasted", "disappointing"),
                                      str_to_title(name),
                                      "")), 
                 size = 3.5, 
                 alpha = .9, 
                 colour = "#00afb9", 
                 fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of One-star Chinese Restaurant Review Descriptions", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: maps.google.com; Ng Choon Khon")

ggsave(here("plots", "google_chinese_1_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
```

```{r}
google_chinese_1_or_2_star_words <- google_kl_cuisine |> 
  clean_common_foods() |>  
  mutate(review_id = row_number()) |> 
  filter(cuisine == "Chinese" & rating <= 2) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 10) |> 
  pairwise_cor(word, review_id, sort = TRUE, upper = FALSE) |> 
  filter(correlation >= .16) |> 
  left_join(
    google_kl_cuisine |> 
      clean_common_foods() |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine == "Chinese" & rating <= 2) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(str_detect(word, "[a-z]")) |> 
      add_count(word) |> 
      filter(n > 10) |> 
      pairwise_count(word, review_id, sort = TRUE, upper = FALSE), 
    by = c("item1", "item2"))
  
google_chinese_1_or_2_star_network <- google_chinese_1_or_2_star_words |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 2.5), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  geom_node_text(aes(label = ifelse(name %in% 
                                        c("wait", "service", "experience", 
                                          "price", "quality", "fish",
                                          "noodle", "soup", "crispy", "skin", 
                                          "fresh", "tasted", "disappointing"),
                                      str_to_title(name),
                                      "")), 
                 size = 3.5, 
                 alpha = .9, 
                 colour = "#00afb9", 
                 fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of One and Two-star Chinese Restaurant Review Descriptions", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: maps.google.com; Ng Choon Khon")

ggsave(here("plots", "google_chinese_1_or_2_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
```

```{r}
google_western_1_star_network <- google_kl_cuisine |> 
  clean_common_foods() |>  
  mutate(review_id = row_number()) |> 
  filter(cuisine == "Casual Western" & rating <= 2) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 10) |> 
  pairwise_cor(word, review_id, sort = TRUE, upper = FALSE) |> 
  filter(correlation >= .15) |> 
  left_join(
    google_kl_cuisine |> 
      clean_common_foods() |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine == "Casual Western" & rating <= 2) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(str_detect(word, "[a-z]")) |> 
      add_count(word) |> 
      filter(n > 10) |> 
      pairwise_count(word, review_id, sort = TRUE, upper = FALSE), 
    by = c("item1", "item2")
  )
  
google_western_1_star_network |> 
  arrange(desc(n))
```

```{r}

trip_word_list <- c("it's|don't")

trip_chinese_1_star_network_network <- trip_kl_cuisine |> 
  mutate(review_id = row_number()) |> 
  filter(cuisine == "Chinese" & rating == 1) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(!str_detect(word, "'")) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 13) |> 
  pairwise_cor(word, review_id, sort = TRUE) |> 
  filter(correlation >= .2) |> 
  left_join(
    trip_kl_cuisine |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine == "Chinese" & rating == 1) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(!str_detect(word, "'")) |>
      filter(str_detect(word, "[a-z]")) |>
      add_count(word) |> 
      filter(n > 13) |> 
      pairwise_count(word, review_id, sort = TRUE), 
    by = c("item1", "item2")
  ) |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 2.5), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  # geom_node_text(aes(label = ifelse(name %in% 
  #                                       c("waited", "service", "experience", 
  #                                         "price", "quality", "fresh", 
  #                                         "tasted", "disappointing"),
  #                                     str_to_title(name),
  #                                     "")), 
  #                size = 3.5, 
  #                alpha = .9, 
  #                colour = "#00afb9", 
  #                fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of One-star Chinese Restaurant Trip Advisor Review", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: TripAdvisor.com; Ng Choon Khon")


ggsave(here("plots", "trip_chinese_1_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
```

```{r}
google_kl_cuisine |> 
  filter(cuisine == "Chinese") |> 
  ggplot(aes(x = rating)) + 
  geom_histogram() +

trip_kl_cuisine |> 
  filter(cuisine == "Chinese") |> 
  ggplot(aes(x = rating)) + 
  geom_histogram()
```

```{r}
trip_kl_cuisine |>  
  filter(cuisine == "Chinese" & rating == 1) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |>
  filter(str_detect(word, "[a-z]")) |> 
  filter(!str_detect(word, trip_word_list)) |> 
  add_count(word) |> 
  filter(n > 10) |> 
  pairwise_cor(word, row_id, sort = TRUE) |> 
  filter(correlation >= .2) |> 
  left_join(
    trip_kl_cuisine |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine == "Chinese" & rating == 1) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(str_detect(word, "[a-z]")) |>
      filter(!str_detect(word, trip_word_list)) |> 
      add_count(word) |> 
      filter(n > 10) |> 
      pairwise_count(word, review_id, sort = TRUE), 
    by = c("item1", "item2")
  ) |> 
  arrange(desc(n))
```

```{r}
thai_1_star_network <- google_reviews_with_cuisine |> 
  mutate(review_id = row_number()) |> 
  filter(cuisine == "Thai" & rating == 1) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 10) |> 
  pairwise_cor(word, review_id, sort = TRUE) |> 
  filter(correlation >= .10) |> 
  left_join(
    google_reviews_with_cuisine |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine == "Thai" & rating == 1) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(str_detect(word, "[a-z]")) |> 
      add_count(word) |> 
      filter(n > 10) |> 
      pairwise_count(word, review_id, sort = TRUE), 
    by = c("item1", "item2")
  ) |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 2.5), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  geom_node_text(aes(label = ifelse(name %in% 
                                        c("waited", "service", "experience", 
                                          "price", "quality", "fresh", 
                                          "tasted", "disappointing", 
                                          "tom", "yam", "fried", "rice", 
                                          "worst"),
                                      str_to_title(name),
                                      "")), 
                 size = 3.5, 
                 alpha = .9, 
                 colour = "#00afb9", 
                 fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of One-star Thai Restaurant Review Descriptions", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: maps.google.com; Ng Choon Khon")

ggsave(here("plots", "thai_1_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
```

```{r}
japanese_1_star_network <- google_reviews_with_cuisine |> 
  mutate(review_id = row_number()) |> 
  filter(cuisine == "Japanese" & rating == 1) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 10) |> 
  pairwise_cor(word, review_id, sort = TRUE) |> 
  filter(correlation >= .15) |> 
  left_join(
    google_reviews_with_cuisine |> 
      mutate(review_id = row_number()) |> 
      filter(cuisine == "Japanese" & rating == 1) |> 
      unnest_tokens(word, review) |> 
      anti_join(stop_words) |> 
      filter(str_detect(word, "[a-z]")) |> 
      add_count(word) |> 
      filter(n > 10) |> 
      pairwise_count(word, review_id, sort = TRUE), 
    by = c("item1", "item2")
  ) |> 
  igraph::graph_from_data_frame() |> 
  ggraph(layout = "fr") + 
  geom_edge_link(aes(alpha = correlation, edge_width = n), colour = "#457b9d", check_overlap = TRUE) +
  scale_edge_width_continuous(range = c(.1, 2.5), trans = "log10") +
  scale_alpha_continuous(range = c(0.01, 0.08)) +
  geom_node_point(colour = "#457b9d", alpha = 0.2, size = .5) +
  geom_node_text(aes(label = ifelse(name %in% 
                                        c("waited", "service", "experience", 
                                          "price", "quality", "fresh", 
                                          "tasted", "disappointing", "worst"),
                                      str_to_title(name),
                                      "")), 
                 size = 3.5, 
                 alpha = .9, 
                 colour = "#00afb9", 
                 fontface = "bold") +
  geom_node_text(aes(label = name), size = 3.1, alpha = .4, 
                 colour = "#caf0f8") + 
  theme(legend.position = "none", 
        plot.caption = element_text(hjust = .5, colour = "#219ebc"), 
        panel.background = element_rect(fill = "#03071e"), 
        plot.background = element_rect(fill = "#1b263b"), 
        plot.title = element_text(colour = "#219ebc"), 
        plot.subtitle = element_text(colour = "#219ebc", size = 10)) + 
  labs(title = "Network graph of One-star Japanese Restaurant Review Descriptions", 
       subtitle = "Line thickness indicates number of events involving those words, line transparency indicates the correlation between words. Key topics highlighted.", 
       caption = "Source: maps.google.com; Ng Choon Khon")

ggsave(here("plots", "japanese_1_star_network_graph.png"), 
       width = 10, height = 6.5, units = "in", dpi = 300)
```

```{r}
google_reviews_with_cuisine |> 
  mutate(review_id = row_number()) |> 
  filter(cuisine == "Chinese" & rating == 1) |> 
  unnest_tokens(word, review) |> 
  anti_join(stop_words) |> 
  filter(str_detect(word, "[a-z]")) |> 
  add_count(word) |> 
  filter(n > 10) |> 
  distinct(word, n) |> 
  arrange(desc(n))
```

We have filtered these datasets down to

```{r}

trip_google_restaurant_scatter <- function(tbl){
  
  tbl |> 
    group_by(cuisine, restaurant) |> 
    summarise(mean_rating = mean(rating), 
              reviews = n(), 
              median_rating = median(rating)) |> 
    arrange(desc(mean_rating)) |> 
    filter(reviews >= 30) |> 
    ggplot(aes(x = reviews, 
               y = mean_rating)) + 
    geom_point() + 
    scale_x_log10() + 
    geom_smooth(method = "lm", alpha = .3) + 
    labs(subtitle = "Excludes restaurants with less than 30 reviews",
         x = "Number of reviews", 
         y = "Mean rating")
}

trip_kl_cuisine |> 
  trip_google_restaurant_scatter() +
  labs(title = "Trip Advisor reviews ") +
  
google_kl_cuisine |> 
  trip_google_restaurant_scatter() +
  labs(title = "Google reviews")
  glimpse()
```

**Other Upmarket** This is for restaurants where it is not immediately apparent what cuisine they are besides expensive. This is the bracket for hotel restaurants, self-described "international" restaurants or where they do not provide a cuisine descriptor, as well as places where the experience is the focus. There are also high-end fusion restaurants where the cuisine was not apparent, though there is also one restaurant that "excels at impressing Westerners with Orientalist cuisine", according to Trip Advisor.

A restaurant that excels at impressing Westerners with Orientalist cuisine.

Casual Western includes bistros

What is the line between Casual Western and Other Upmarket?

[Botanica](https://share.google/KzeyuQU0Ut9t6tZuR) vs [Wizards at Tribeca](https://share.google/gvaKF5e7afa7UvGAo), now called Kaka.

**Casual Western** This massive category

In a case_when sequence, which is R's version of nested if-elses, you might want to start

```{r}
author_location <- trip_kl_cuisine |> 
  count(author) |> 
  arrange(desc(n)) |> 
  
  mutate(author_location = case_when(
    str_detect(author, 
               "Kuala Lumpur, Malaysia|KL, Malaysia|kuala lumpur|Kl|KL|Ampang, Malaysia|Kuala Lumpur, Wilayah Persekutuan, Malaysia|K.Lumpur|Ampang, Malaysia|Bangsar|Kuala Lumpur|Kuala Lumpur, Msia|Puchong|KUALA LUMPUR"
               ) ~ "Kuala Lumpur, Malaysia",
    str_detect(author, "Petaling Jaya, Malaysia|Petaling Jaya, Selangor, Malaysia|Selangor, Malaysia|selangor|Petaling Jaya|selangor"
               ) ~ "Petaling Jaya, Malaysia", 
    str_detect(author, "Subang Jaya, Malaysia") ~ "Subang Jaya, Malaysia",
    str_detect(author, "Shah Alam, Malaysia|Shah Alam") ~ "Shah Alam, Malaysia", 
    str_detect(author, "Klang, Malaysia") ~ "Klang, Malaysia",
    str_detect(author, "Raub District, Malaysia") ~ "Raub District, Malaysia",
    str_detect(author, "Johor Bahru, Malaysia") ~ "Johor Bahru, Malaysia",
    str_detect(author, "Penang Island, Malaysia|Penang") ~ "Penang Island, Malaysia",
    str_detect(author, "Kota Kinabalu, Malaysia") ~ "Kota Kinabalu, Malaysia",
    str_detect(author, "Kuching, Malaysia") ~ "Kuching, Malaysia",
    str_detect(author, "Langkawi, Malaysia") ~ "Langkawi, Malaysia",
    str_detect(author, "Seremban, Malaysia") ~ "Seremban, Malaysia",
    str_detect(author, "Putrajaya, Malaysia") ~ "Putrajaya, Malaysia",
    
    str_detect(author, "Singapore, Singapore") ~ "Singapore, Singapore",
    
    str_detect(author, "Brighton, United Kingdom") ~ "Brighton, United Kingdom", 
    str_detect(author, "London, United Kingdom|London") ~ "London, United Kingdom",
    str_detect(author, "Cambridge, United Kingdom") ~ "Cambridge, United Kingdom",
    str_detect(author, "Devon, United Kingdom") ~ "Devon, United Kingdom",
    str_detect(author, "Glasgow, United Kingdom") ~ "Glasgow, United Kingdom",
    str_detect(author, "Sheffield, United Kingdom") ~ "Sheffield, United Kingdom",
    str_detect(author, "Middlesbrough, United Kingdom") ~ "Middlesbrough, United Kingdom",
    str_detect(author, "Richmond, United Kingdom") ~ "Richmond, United Kingdom",
    str_detect(author, "Gosport, United Kingdom") ~ "Gosport, United Kingdom",
    str_detect(author, "Harrogate, United Kingdom") ~ "Harrogate, United Kingdom",
    str_detect(author, "Edinburgh, United Kingdom") ~ "Edinburgh, United Kingdom",
    str_detect(author, "Swansea, United Kingdom") ~ "Swansea, United Kingdom",
    str_detect(author, "Aberdeen, United Kingdom") ~ "Aberdeen, United Kingdom",
    str_detect(author, "Yorkshire, United Kingdom") ~ "Yorkshire, United Kingdom",
    str_detect(author, "Towcester, United Kingdom") ~ "Towcester, United Kingdom",
    str_detect(author, "York, United Kingdom") ~ "York, United Kingdom",
    str_detect(author, "Taunton, United Kingdom") ~ "Taunton, United Kingdom",
    
    str_detect(author, "Cairns, Australia") ~ "Cairns, Australia",
    str_detect(author, "Sydney, Australia") ~ "Sydney, Australia",
    str_detect(author, "Melbourne, Australia") ~ "Melbourne, Australia",
    str_detect(author, "Brisbane, Australia|Brisbane, Queensland, Australia") ~ "Brisbane, Australia",
    str_detect(author, "New South Wales, Australia") ~ "New South Wales, Australia",
    str_detect(author, "Bunbury, Australia") ~ "Bunbury, Australia",
    str_detect(author, "Varsity Lakes, Australia") ~ "Varsity Lakes, Australia",
    str_detect(author, "Perth, Australia|Perth") ~ "Perth, Australia",
    str_detect(author, "Adelaide, Australia") ~ "Adelaide, Australia",
    str_detect(author, "Gold Coast, Australia") ~ "Gold Coast, Australia",
    str_detect(author, "Western Australia, Australia") ~ "Western Australia, Australia",
 
    
    str_detect(author, "Oxon Hill, Maryland") ~ "Oxon Hill, Maryland",
    str_detect(author, "Princeton, New Jersey") ~ "Princeton, New Jersey",
    str_detect(author, "Tijeras, New Mexico") ~ "Tijeras, New Mexico",
    str_detect(author, "Polaris, Montana") ~ "Polaris, Montana",
    str_detect(author, "Chicago, Illinois") ~ "Chicago, Illinois",
    str_detect(author, "Palm Springs, California") ~ "Palm Springs, California",
    str_detect(author, "Wenatchee, Washington") ~ "Wenatchee, Washington",
    str_detect(author, "Cypress, Texas") ~ "Cypress, Texas",
    str_detect(author, "Washington DC, District of Columbia") ~ "Washington DC, District of Columbia",
    str_detect(author, "Las Vegas, Nevada") ~ "Las Vegas, Nevada",
    str_detect(author, "Columbia, Connecticut") ~ "Columbia, Connecticut",
    str_detect(author, "Scottsdale, Arizona") ~ "Scottsdale, Arizona",
    str_detect(author, "Pittsburgh, Pennsylvania") ~ "Pittsburgh, Pennsylvania",
    str_detect(author, "Greenville, South Carolina") ~ "Greenville, South Carolina",
    str_detect(author, "Columbia, Connecticut") ~ "Columbia, Connecticut",
    str_detect(author, "Ocean View, Delaware") ~ "Ocean View, Delaware",
    str_detect(author, "Beverly, Massachusetts") ~ "Beverly, Massachusetts", 
     
    str_detect(author, "Wels, Austria") ~ "Wels, Austria",
    str_detect(author, "Lienz, Austria") ~ "Lienz, Austria",
    str_detect(author, "Brussels, Belgium") ~ "Brussels, Belgium",
    str_detect(author, "Bandar Seri Begawan, Brunei Darussalam") ~ "Bandar Seri Begawan, Brunei Darussalam",
    str_detect(author, "Phnom Penh, Cambodia") ~ "Phnom Penh, Cambodia",
    str_detect(author, "Siem Reap, Cambodia") ~ "Siem Reap, Cambodia",
    str_detect(author, "Toronto, Canada") ~ "Toronto, Canada",
    str_detect(author, "Vancouver, Canada") ~ "Vancouver, Canada",
    str_detect(author, "Beijing, China|Beijing") ~ "Beijing, China",
    str_detect(author, "Suzhou, China") ~ "Suzhou, China",
    str_detect(author, "Shanghai, China") ~ "Shanghai, China",
    str_detect(author, "Hong Kong, China") ~ "Hong Kong, China",
    str_detect(author, "Paphos, Cyprus") ~ "Paphos, Cyprus",
    str_detect(author, "Copenhagen, Denmark") ~ "Copenhagen, Denmark",
    str_detect(author, "Mumbai, India|Mumbai") ~ "Mumbai, India",
    str_detect(author, "Jakarta, Indonesia|Jakarta") ~ "Jakarta, Indonesia",
    str_detect(author, "Seminyak, Indonesia") ~ "Seminyak, Indonesia",
    str_detect(author, "Bandung, Indonesia") ~ "Bandung, Indonesia", 
    str_detect(author, "Levu, Fiji") ~ "Levu, Fiji",
    str_detect(author, "Cologne, Germany") ~ "Cologne, Germany",
    str_detect(author, "Stuttgart, Germany") ~ "Stuttgart, Germany",
    str_detect(author, "Helsinki, Finland") ~ "Helsinki, Finland",
    str_detect(author, "Hyderabad, India") ~ "Hyderabad, India",
    str_detect(author, "Western Ireland, Ireland") ~ "Western Ireland, Ireland",
    str_detect(author, "Shinjuku, Japan") ~ "Shinjuku, Japan",
    str_detect(author, "Tokyo, Japan") ~ "Tokyo, Japan",
    str_detect(author, "Kyoto, Japan") ~ "Kyoto, Japan",
    str_detect(author, "Amman, Jordan") ~ "Amman, Jordan",
    str_detect(author, "Seoul, South Korea") ~ "Seoul, South Korea",
    str_detect(author, "Kuwait City, Kuwait") ~ "Kuwait City, Kuwait",
    str_detect(author, "Luang Prabang, Laos") ~ "Luang Prabang, Laos",
    str_detect(author, "Island of Malta, Malta") ~ "Island of Malta, Malta",
    str_detect(author, "Port Louis") ~ "Port Louis, Mauritius",
    str_detect(author, "Mexico City, Mexico") ~ "Mexico City, Mexico",
    str_detect(author, "Bacalar, Mexico") ~ "Bacalar, Mexico",
    str_detect(author, "The Hague, The Netherlands") ~ "The Hague, The Netherlands",
    str_detect(author, "Delft, The Netherlands") ~ "Delft, The Netherlands",
    str_detect(author, "Paraparaumu, New Zealand") ~ "Paraparaumu, New Zealand",
    str_detect(author, "Kristiansand, Norway") ~ "Kristiansand, Norway",
    str_detect(author, "Muscat, Oman") ~ "Muscat, Oman",
    str_detect(author, "Manila, Philippines") ~ "Manila, Philippines",
    str_detect(author, "Pasig, Philippines") ~ "Pasig, Philippines",
    str_detect(author, "Quezon City, Philippines") ~ "Quezon City, Philippines",
    str_detect(author, "Lisbon District, Portugal") ~ "Lisbon District, Portugal",
    str_detect(author, "Sintra, Portugal") ~ "Sintra, Portugal",
    str_detect(author, "Kazan, Russia") ~ "Kazan, Russia",
    str_detect(author, "Sakhalinsk, Russia") ~ "Sakhalinsk, Russia",
    str_detect(author, "Jeddah, Saudi Arabia") ~ "Jeddah, Saudi Arabia",
    str_detect(author, "Barcelona, Spain") ~ "Barcelona, Spain",
    str_detect(author, "Torremolinos, Spain") ~ "Torremolinos, Spain",
    str_detect(author, "Hermanus, South Africa") ~ "Hermanus, South Africa",
    str_detect(author, "Johannesburg, South Africa") ~ "Johannesburg, South Africa",
    str_detect(author, "Colombo, Sri Lanka") ~ "Colombo, Sri Lanka",
    str_detect(author, "Negombo, Sri Lanka") ~ "Negombo, Sri Lanka",
    str_detect(author, "Lund, Sweden") ~ "Lund, Sweden",
    str_detect(author, "Stockholm, Sweden") ~ "Stockholm, Sweden",
    str_detect(author, "Zurich, Switzerland") ~ "Zurich, Switzerland",
    str_detect(author, "Geneva, Switzerland") ~ "Geneva, Switzerland",
    str_detect(author, "Baar, Switzerland") ~ "Baar, Switzerland",
    str_detect(author, "New Taipei, Taiwan") ~ "New Taipei, Taiwan",
    str_detect(author, "Taipei, Taiwan") ~ "Taipei, Taiwan",
    str_detect(author, "Bangkok, Thailand") ~ "Bangkok, Thailand",
    str_detect(author, "Chiang Mai, Thailand") ~ "Chiang Mai, Thailand",
    str_detect(author, "Phuket, Thailand") ~ "Phuket, Thailand",
    str_detect(author, "Antalya, Turkey") ~ "Antalya, Turkey",
    str_detect(author, "Dubai, United Arab Emirates") ~ "Dubai, United Arab Emirates",
    str_detect(author, "Hanoi, Vietnam") ~ "Hanoi, Vietnam",
    str_detect(author, "Ho Chi Minh City, Vietnam") ~ "Ho Chi Minh City, Vietnam",
    
    str_detect(author, "Doha, Qatar") ~ "Doha, Qatar",
    str_detect(author, "Treviso, Italy") ~ "Treviso, Italy",
    str_detect(author, "Pembroke Pines, Florida") ~ "Pembroke Pines, Florida",
    str_detect(author, "New York City, New York") ~ "New York City, New York",
    str_detect(author, "Pattaya, Thailand") ~ "Pattaya, Thailand",
    str_detect(author, "Zagreb, Croatia") ~ "Zagreb, Croatia",
    str_detect(author, "Prague, Czech Republic") ~ "Prague, Czech Republic",
    str_detect(author, "Treviso, Italy") ~ "Treviso, Italy",
    str_detect(author, "Kathmandu, Nepal") ~ "Kathmandu, Nepal",
    str_detect(author, "Rome, Italy") ~ "Rome, Italy",
    str_detect(author, "Nantes, France") ~ "Nantes, France",
    str_detect(author, "Thaa Atoll, Maldives") ~ "Thaa Atoll, Maldives",
    str_detect(author, "Atlanta, Georgia") ~ "Atlanta, Georgia",
    str_detect(author, "Idaho") ~ "Idaho",
    str_detect(author, "Newcastle, UK") ~ "Newcastle, United Kingdom",
    str_detect(author, "Bristol") ~ "Bristol, United Kingdom",
    str_detect(author, "Baku, Azerbaijan") ~ "Baku, Azerbaijan",
    str_detect(author, "Dhaka City, Bangladesh") ~ "Dhaka City, Bangladesh",
    str_detect(author, "Lyon, France") ~ "Lyon, France",
    str_detect(author, "Cuenca, Ecuador") ~ "Cuenca, Ecuador",
    str_detect(author, "Hendersonville, North Carolina") ~ "Hendersonville, North Carolina",
    str_detect(author, "Miami, Florida") ~ "Miami, Florida",
    str_detect(author, "Mentana, Italy") ~ "Mentana, Italy",
    str_detect(author, "Francistown, Botswana") ~ "Francistown, Botswana",
    str_detect(author, "Duhok, Iraq") ~ "Duhok, Iraq",
    str_detect(author, "Nur-Sultan, Kazakhstan") ~ "Nur-Sultan, Kazakhstan",
    str_detect(author, "Kathmandu, Nepal") ~ "Kathmandu, Nepal",
    str_detect(author, "Sanaa, Yemen") ~ "Sanaa, Yemen",
    str_detect(author, "Athens, Greece") ~ "Athens, Greece",
    TRUE ~ "Other"
  )) |> 
  
  
  mutate(author_country = case_when(
    str_detect(author, "Malaysia|malaysia") | 
      str_detect(author_location, "Malaysia"
                 ) ~ "Malaysia", 
    str_detect(author, "Singapore") ~ "Singapore", 
    str_detect(author, "Indonesia|Jakarta") ~ "Indonesia",
    str_detect(author, "Australia|Perth") ~ "Australia",
    str_detect(author, "United Kingdom|London|UK|Bristol") ~ "United Kingdom",
    str_detect(author, "Maryland|New Jersey|New Mexico|Montana|California|Illinois|Washington|Texas|Nevada|District of Columbia|Connecticut|Arizona|Pennsylvania|Delaware|South Carolina|Massachusetts|Florida|American Expat|Georgia|North Carolina|New York|Georgia|Idaho|United States|West coast, USA"
               ) ~ "United States",
    str_detect(author, "Austria") ~ "Austria",
    str_detect(author, "Azerbaijan") ~ "Azerbaijan",
    str_detect(author, "Belgium") ~ "Belgium",
    str_detect(author, "Brunei") ~ "Brunei Darussalam",
    str_detect(author, "Cambodia") ~ "Cambodia",
    str_detect(author, "Canada") ~ "Canada",
    str_detect(author, "China") ~ "China",
    str_detect(author, "Cyprus") ~ "Cyprus",
    str_detect(author, "Denmark") ~ "Denmark",
    str_detect(author, "Fiji") ~ "Fiji",
    str_detect(author, "France") ~ "France", 
    str_detect(author, "Finland") ~ "Finland",
    str_detect(author, "Germany") ~ "Germany",
    str_detect(author, "India|Mumbai") ~ "India",
    str_detect(author, "Italy") ~ "Italy",
    str_detect(author, "Ireland") ~ "Ireland", 
    str_detect(author, "Japan") ~ "Japan",
    str_detect(author, "Jordan") ~ "Jordan",
    str_detect(author, "Korea") ~ "Korea",
    str_detect(author, "Kuwait") ~ "Kuwait",
    str_detect(author, "Laos") ~ "Laos",
    str_detect(author, "Thaa Atoll|Maldives") ~ "Maldives", 
    str_detect(author, "Malta") ~ "Malta", 
    str_detect(author, "Mexico") ~ "Mexico",
    str_detect(author, "Oman") ~ "Oman",
    str_detect(author, "Mauritius|Port Louis") ~ "Mauritius",
    str_detect(author, "Norway") ~ "Norway",
    str_detect(author, "The Netherlands") ~ "The Netherlands",
    str_detect(author, "New Zealand") ~ "New Zealand",
    str_detect(author, "Philippines") ~ "Philippines",
    str_detect(author, "Portugal") ~ "Portugal",
    str_detect(author, "Russia") ~ "Russia",
    str_detect(author, "Saudi Arabia") ~ "Saudi Arabia",
    str_detect(author, "Spain") ~ "Spain",
    str_detect(author, "South Africa") ~ "South Africa",
    str_detect(author, "Sri Lanka") ~ "Sri Lanka",
    str_detect(author, "Sweden") ~ "Sweden",
    str_detect(author, "Switzerland") ~ "Switzerland",
    str_detect(author, "Taiwan") ~ "Taiwan",
    str_detect(author, "Thailand") ~ "Thailand",
    str_detect(author, "Turkey") ~ "Turkey",
    str_detect(author, "United Arab Emirates") ~ "United Arab Emirates",
    str_detect(author, "Vietnam") ~ "Vietnam",
    str_detect(author, "Yemen") ~ "Yemen",
    
    TRUE ~ "Other"
  )) 


```

```{r}
author_location |> 
  filter(author_country != "Other") |> 
  count(author_country) |> 
  arrange(desc(n)) |> 
  head(15) |> 
  ggplot(aes(x = n, 
             y = fct_reorder(author_country, n))) + 
  geom_col()
  filter(author_country == "Other")
  glimpse()
```

```{r}
google_kl_cuisine |> 
  group_by(restaurant) |> 
  mutate(review_count = n()) |> 
  ungroup() |> 
  filter(review_count >= 50) |> 
  group_by(cuisine) |> 
  summarise(reviews = n(), 
            restaurants = n_distinct(restaurant), 
            rating = mean(rating)) |> 
  mutate(reviews_per_restaurant = reviews / restaurants) |> 
  ggplot(aes(x = restaurants, 
             y = rating)) + 
  geom_point(aes(size = reviews)) + 
  ggrepel::geom_text_repel(aes(label = cuisine)) + 
  geom_smooth(method = "lm", alpha = .2, size = 0, span = .5) + 
  geom_smooth(method = "lm", se = FALSE) + 
  labs(title = "Number of Restaurants and mean Trip Advisor rating per cuisine", 
       x = "Restaurants", 
       y = "Mean Rating")
  scale_x_log10(breaks = 0, 3, 6, 10, 30, 60) 
```

We see from the plot below that Chinese, Casual Western and South Asian are the most common and commonly-reviewed restaurants, with Chinese and Thai restaurants having the lowest mean ratings.

```{r reviews-cuisine-cleaning-duplicate}

reviews_cuisine_cleaning <- function(tbl) {
  
  tbl |> 
    # Not a specific restaurant
    filter(restaurant %out% c("Jalan Alor", "Sham's Cooked With Love", "Hawker Stalls in Chinatown",
                              "Feast Village Starhill Gallery", "ICC Pudu", "Imbi Market", 
                              "Taste of Asia")) |> 
    # Some cleaning 
    mutate(restaurant = str_replace(restaurant, "Birch", "Huckleberry")) |> 
    mutate(restaurant = str_replace_all(restaurant, "Passage thru'", "Passage Thru"),
           restaurant = str_replace_all(restaurant, "Gravybaby", "GravyBaby"))  |>
    mutate(
      cuisine = case_when(
        
        # The order of the case_when statements is important. Particularly, it should go
        # South Asian -> Buffet -> Fusion,
        # Also, Grill before Bar
        
          str_detect(
          restaurant,
          "Grill|Steakhouse|Grub|Steak|Brasserie|steakhouse|BBQ|Rock Salt Restaurant|BBP|Churrascaria|Marble 8|Beast|Nando's|Nandos|Bar B Q|Down to Bones|Barbecue|Vantador|Bbq|Butcher Carey"
        ) ~ "Grill",
          str_detect(restaurant,
          "Bistro|Deli|Secret Recipe|Tujo|Wild Sheep|Antipodean|Coffee|One Half|Blue Room|Awesome Canteen|Botanica|Chili's|Don's Diner|GravyBaby|Hornbill|Huck's|myBurgerLab|Naj & Belle|Tony Roma's|Louisiana|Cor Blimey|4Fingers|Bacon And Balls|POP PIZZA|After Black|Ashley's by Living Food|March Azalea Kitchen|Mighty Monster IPC|Sköhns Canteen|Table9|Rabbit Hole|Williams Corner|Tiki Taka|4 Fingers|Ben's|Souled Out|Suzi's Corner|Fuel Shack Signature|SOULed OUT|TGI Friday|Chilli's|Pigs & Wolf|Ship|Breakfast Thieves|Ante|Morganfield's|Subway|Meat The Porkers|Pan & Tamper|Hubba Mont Kiara|Bacon & Balls|Tate|Gin Ger|Fuel Shack|Jarrod & Rawlins|BreadFruits|Glass Tartines and Tipples|B-Lab|Mighty Monster|Ticklish Ribs|Cozy Corner|Duddha|Fat Brother|Define:food|Tangerine|Sausage & Ribs Shack|Texas Chicken"
        ) ~ "Casual Western",
        str_detect(
          restaurant,
          "Chinese|Taiwan|[\\p{Han}]|Nam Heong|Dynasty|Putien|Hoi|Gold Dragon|Han Room|Village Duck|Village Roast Duck|Unique|Steamboat|Ah |Roast Pork|Hokkien Mee|Dim Sum|Lai Po Heen|Yun House|Chynna|Li Yen|Shanghai|Lai Foong|Little Penang Kafé|Goon Wah|Shang Palace|YEN|Yut Kee|Din Tai Fung|Dragon-i|Celestial Court|The Ming Room|Sai Woo|Luk Yu|Yue|Way Modern Chinois|Hong Kong|Blue Boy Vegetarian Food Centre|Xin|Lai Ching Yuen|Noble House|Noodle House|Bak Kut Teh|Fong Lye|Wan Tan Mee|Sarawak Laksa|Hakka|Ruyi & Lyn|Chicken rice|Chicken Rice|Char Siew|Siew Yoke|Dim Sum|Chiu Chow|Hainan|Hailam|Pork Noodles|Koong Woh Tong|Yong Tow Foo|Madam Tang| Kee|The Pot KL|Yu Noodle Cuisine|Wan Chun Ting|Muk Koot|Oversea|Marco Polo|Cu Cha Restaurant|Imperial|Grand Harbour|In Colonial Restaurant|Museum Restaurant|Heng|Hiong Kong|Ban Lee Restaurant|Heong|Restaurant Mama Love"
        ) ~ "Chinese",
        str_detect(
          restaurant,
          "Italia|Olive|Ristorante|Osteria|Prego|Pizza|Trattoria|Nero Nero|Positano|a'Roma|Vin's Restaurant|Michelangelo|Marini's|Nizza|Porto Romano|Tatto|Neroteca|La Risata|Portofino|Ciao|Enoteca|Mangiare|Sassolino|Pizzeria|La Casa Restaurant & Patisserie"
        ) ~ "Italian",
        str_detect(
          restaurant,
          "German|French|Chez|Marta's|Tapas|Bistro à Table|Iberico|El Toro Loco|Petit|Mercat|Dominic|El Cerdo|Quivo|Skillet KL|iberico|Yeast|Maison Francaise|El Mesón|Lafite|Topshelf|Wurst|Sabayon|Chateau|Naughty Babe Dirty Duck|Hit & Mrs|Le Gourmandin|Soleil|Suisse|IKEA"
        ) ~ "European",
        str_detect(restaurant, "Thai|Bangkok|BKK|Baan|Tamarind Springs|Chakri|BAAN|Samira by Asian Terrace|Ekkamai|Busaba|Mamasan|Krung Thep|Tomyam|Aroma Restaurant"
                   ) ~ "Thai",
        str_detect(restaurant, "Arab|Turkish|Al-|Halab|Egyptian|Tarbush|Wadi|Sahara Tent|Shawarma|Damascus|Syria|Hadramawt|diafah|Iraq|Sarifa|Al Rawsha|The Castle Restaurant|Saba Restaurant|Marhaba Restaurant|Antara|Andalus"
                   ) ~ "Levantine",
        # Malay (Chef Wan) and Malaysian (Madan Kwan's)
        str_detect(
          restaurant,
          "Malay|Rasa|Cik|Dapur|Rebung|Zakhir|Village Park|ADU|Warisan|Nasi|Dancing Fish|Sarang|Bijan|Serai|Sambal|ATAS at The RuMa Hotel|Grandmama's|Onde Onde|JP teres|Satay Station|Chef Wan|De.Wan|Siti Li Dining|Pintu|Ramly|Penyet|Sepiring|Satay|Restoran Ali Food Corner|Open House"
        ) ~ "Malay",
        str_detect(
          restaurant,
          "Nonya|Baba|Mum's Place|Madam Kwan|Chuup|Old China Cafe|Nyonya|Little Penang|Oriental Cravings|Papparich|Uncle Don|Muar Restaurant|Kumi|Peranakan|1919 Restaurant"
        ) ~ "Malaysian",
        str_detect(
          restaurant,
          "Japan|Edo|Sushi|Kampachi|Iketeru|Menya|Nobu|Omakase|TOKYO|Tokyo|Tonkatsu|Udon|Soba|Ichibanya|Maruhi|Omulab|Zipangu|Miyabi|Izakaya Hanazen|hokkaido|Senya|IPPUDO|Umai-Ya|Ichiban|Yakiniku|Nihon|Lucky Tora|Hokkaido|Mo-Mo Paradise|Sushi|sushi|Uokatsu|Ramen|Tempura|Izakaya|Tokyo|Kyoto|Oishii|Gyoza|Ichiban|Tonkotsu|Tonkatsu|Sakura|Yakitori|Kyush|Teppanyaki|Taka|Kikubari|Ichiyutei|Enju|Okonomi|Toridoki|Syokudo|Tsukiji|Yuzu"
        ) ~ "Japanese",
        # Why not merge all Korean BBQ into grill?
        str_detect(
          restaurant,
          "Filipino|Bali|Vietnam|GOODDAM|Korea|Sao Nam|Naughty Nuri's|KyoChon|Viet|Dakgalbi|Sopoong|Kung Jung|Saigon|Sae Ma Eul|KoRyo-Won|Koryowon|Persia|Astana"
        ) ~ "Other Asian",
        # Do not str_detect(.x, "bar")
        str_detect(restaurant, "Whisky|Lounge|Bar|Decanter|Knowhere Bangsar|The Locker & Loft|Tom, Dick & Harry's|WET|The Enclave|Out of Africa|Opium|THIRTY8|Healy Mac's|TEMPTationS|Loco bar|La Bodega|Vertigo|The Social|No Black Tie|The BAR|O'Galito|Table 23|D Legends bar|Bobo KL|Rock Bottom|twenty-one kitchen+bar|Bentley's Pub|Vinh City Entertainment|twenty-one|Malones|White Horse Tavern|Supperclub KL|Backyard|The Ceylon bar|W1 Dining & Cocktails|Splash|Drop Exchange|Boardwalk|Deep Blue|The Sticky Wicket|OneSixFive|The Attic|Concubine KL|The Green Man|THE BAR"
        ) ~ "Bar",
        str_detect(restaurant, "Cafe|Grind|Café|Tujo|cafe|Alexis|The Loaf|Yellow Brick Road|Huckleberry|TWG|Newens Tea House|Miss Ellie Tea House|Frisky Goat|Urbean|Ra-Ft|Backofen|STG Bukit Ceylon|VCR|Rise & Shine by Tapestry"
        ) ~ "Cafe",
        str_detect(
          restaurant,
          "Kerala|India|Lanka|Malabar|Curry|Raju|Bhavan|Thosai|Tandoor|Bombay|Gem Restaurant|Nasi Kandar|NADODI|Qureshi|RSMY|Sangeetha|Nirwana|Asian Rice Pot|Masala|Annalakshmi|Aliyaa|MTR|Devi's Corner|WTF - What Tasty Food|Nadodi|Delhi Royale|FLOUR|Bakti Woodlands|Vishal Food|Banana Leaf|Hyderabad|sarvana bhavan|Spice Garden|Roti|TasteBud|Chapati|Pakistani|Jai Hind|BananaBro|Naan|SK Corner|Sri Paandi|Majapahit|Nan |GinRikSha|Briyani|Biryani|Maju Palace|Seetharam|Havelly|Punjab|Goa By Sapna Anand|Swaadisht|Mamak|Sri|Chapathi|Moghul|Rani|Aryan|Yarl|Sagar|ABC Foods Corner"
        ) ~ "South Asian",
        
        # Buffet list
        restaurant %in% trip_buffet_list ~ "Buffet",
        str_detect(restaurant, "Flock, W Kuala Lumpur|HYdeout By Grand Hyatt Kuala Lumpur") ~ "Buffet", 
        # List of fusion restaurants
        restaurant %in% trip_fusion_list ~ "Fusion",
        str_detect(restaurant, "Symphony by Chef Jo|Darren Chin|Dewakan|DC Restaurant|Sitka|Ginger Restaurant") ~ "Fusion", 
        
        str_detect(restaurant, "Latino|Mexican|Las Carretas"
        ) ~ "Latino",
        str_detect(restaurant, "Oliver Gourmet|Seafood|Shell Out|BAIT|Fisherman|Fish & Co|Shucked|Delay No More Crab Restaurant"
        ) ~ "Seafood",
        str_detect(restaurant, "Vasco's|Latest Recipe|Lemon Garden|Prime|Gastro Sentral|Chinoz On The Park|Shook|Plane In The City|Contango|The Living Room|Curate At Four Seasons|Beta KL|CEDAR on 15|The Apartment|The Grand Getaway|Strato|Ril's|Chocha|Wizards at Tribeca|Nipah|Joloko|Leonardo's Dining Room & Wine Loft|Roofino Skydining|Troika|Dining In The Dark KL|PLOY|Atlas Gourmet Market|WIP|Nathalie Gourmet Studio|Altitude|The Canteen by Chef Adu|Latitude 03|The Orchid Conservatory|Graze Restaurant|Zende Restaurant|Crystal"
        ) ~ "Other Upmarket",
        # Just mopping up all the Dai Chow
        str_detect(restaurant, "Restoran"
        ) ~ "Chinese",
        TRUE ~ "Other"
  ))
}
```

```{r trip-kl-cuisine}
trip_kl_cuisine <- trip_reviews |> 
  filter(location %in% c("KL", "Petaling Jaya")) |> 
  reviews_cuisine_cleaning() 
```

<br>

```{r}
google_reviews_with_cuisine <- google_reviews |> 
  filter(location %in% c("KL", "Petaling Jaya")) |> 
  group_by(restaurant) |> 
  mutate(review_count = n()) |> 
  ungroup() |> 
  google_reviews_cuisine() |> 
  filter(review_count > 30) 

```

```{r}
google_reviews_with_cuisine |>
  filter(location %in% c("KL", "Petaling Jaya")) |> 
  group_by(restaurant) |> 
  mutate(review_count = n()) |> 
  ungroup() |> 
  filter(review_count > 50) |>
  group_by(cuisine) |> 
  summarise(reviews = n(), 
            restaurants = n_distinct(restaurant), 
            rating = mean(rating)) |> 
  mutate(reviews_per_restaurant = reviews / restaurants) |> 
  arrange(desc(reviews_per_restaurant)) |> 
  ggplot(aes(x = restaurants, 
             y = rating)) +
  geom_point(aes(size = reviews)) + 
  ggrepel::geom_text_repel(aes(label = cuisine)) + 
  geom_smooth(method = "lm", alpha = .2, size = 0, span = .5) + 
  geom_smooth(method = "lm", se = FALSE) + 
  labs(title = "Number of google reviews and mean rating per cuisine", 
       subtitle = "Restaurants with less than 50 reviews excluded")
  scale_x_log10(breaks = 0, 3, 6, 10, 30, 60) 
  
  
```

<br>

```{r}
google_reviews_with_cuisine |> 
  group_by(cuisine) |> 
  summarise(restaurant_count = n_distinct(restaurant), 
            review_count = n(), 
            rating = mean(rating)) |> 
  mutate(reviews_per_restaurant = review_count / restaurant_count) |> 
  arrange(desc(reviews_per_restaurant)) |> 
  ggplot(aes(x = reviews_per_restaurant, 
             y = rating)) + 
  geom_point(aes(size = restaurant_count)) +
  ggrepel::geom_text_repel(aes(label = cuisine))
  
```

```{r}
google_reviews_with_cuisine |> 
  group_by(restaurant) |> 
  summarise(rating = mean(rating), 
            review_count = mean(review_count)) |> 
  ggplot(aes(x = review_count, y = rating)) + 
  geom_point() + 
  scale_x_log10()

google_reviews_with_cuisine |> 
  group_by(restaurant) |> 
  summarise(review_count = mean(review_count)) |> 
  arrange(desc(review_count))

```

```{r}

cuisine_order <- google_reviews_with_cuisine |>
  group_by(cuisine) |> 
  summarise(rating = mean(rating), 
            reviews = n()) |> 
  arrange(desc(rating)) 

google_reviews_with_cuisine |> 
  mutate(rating_factor = as.factor(rating)) |> 
  group_by(cuisine, rating_factor) |> 
  summarise(restaurants = n_distinct(restaurant), 
            reviews = n(), .groups = "drop") |> 
  group_by(cuisine) |> 
  mutate(total_reviews = sum(reviews), 
         pc = reviews / total_reviews,
         total_restaurants = sum(restaurants), 
         position = 1) |> 
  ungroup() |> 
  mutate(cuisine = fct_relevel(cuisine, cuisine_order |> pull(cuisine))) |>
  
  ggplot(aes(x = pc, y = cuisine, fill = rating_factor)) + 
  geom_col(position = "stack") +
  scale_fill_manual(values = c("1" = "#780000", 
                                 "2" = "#c1121f",
                                 "3" = "#fdf0d5", 
                                 "4" = "#669bbc", 
                                 "5" = "#003049")) + 
  scale_x_continuous(labels = percent) + 
  geom_text(aes(y = cuisine, x = position + 0.125, label = comma(total_reviews, accuracy = 1), 
                fill = NULL), 
            data = cuisine_totals |> group_by(cuisine) |> slice(1), 
            hjust = "inward", size = 3) +
  labs(x = "% of Reviews", 
       y = "", 
       fill = "Rating", 
       title = "Breakdown of Restaurant Google Review Ratings, by Cuisine", 
       subtitle = "Limited to Kuala Lumpur and Petaling Jaya. Number of reviews at the end of bars.")
```

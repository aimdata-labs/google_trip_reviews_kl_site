google_reviews_cuisine <- function(tbl) {
  
  tbl |> 
    mutate(restaurant = str_replace_all(restaurant, "Passage thru'", "Passage Thru"),
           restaurant = str_replace_all(restaurant, "Gravybaby", "GravyBaby"))  |>
    mutate(
      cuisine = case_when(
        str_detect(restaurant, "Thai|Bangkok|BKK|Baan") ~ "Thai",
        str_detect(restaurant, "Arab|Turkish|Al-|Halab|Egyptian") ~ "Levantine",
        str_detect(restaurant, "Oliver Gourmet") ~ "Seafood",
        str_detect(
          restaurant,
          "Italia|Olive|Ristorante|Osteria|Prego|Pizza|Trattoria|Nero Nero|Positano|a'Roma|Vin's Restaurant|Michelangelo's"
        ) ~ "Italian",
        str_detect(
          restaurant,
          "German|French|Chez|Marta's|Tapas|Bistro à Table|Iberico|El Toro Loco|Petit|Mercat|Dominic"
        ) ~ "European",
        str_detect(restaurant, "Whisky") ~ "Bar",
        str_detect(
          restaurant,
          "Chinese|Taiwan|[\\p{Han}]|Nam Heong|Dynasty|Putien|Hoi|Gold Dragon|Han Room|Village Duck|Village Roast Duck|Unique|Steamboat|Ah |Roast Pork|Hokkien Mee|Dim Sum|Lai Po Heen|Yun House|Chynna|Li Yen|Shanghai|Madam Kwan|Lai Foong|Little Penang Kafé|Goon Wah|Shang Palace|YEN"
        ) ~ "Chinese",
        str_detect(
          restaurant,
          "Nonya|Baba|Mum's Place|Chuup|Old China Cafe|Nyonya"
        ) ~ "Malaysian",
        str_detect(
          restaurant,
          "Grill|Steakhouse|Grub|Steak|Brasserie|steakhouse|BBQ|Rock Salt Restaurant|BBP|Churrascaria"
        ) ~ "Grill",
        str_detect(
          restaurant,
          "Japan|Edo|Sushi|Kampachi|Iketeru|Menya|Nobu|Omakase|TOKYO|Tokyo|Tonkatsu|Udon|Soba|Ichibanya|Maruhi|Omulab|Zipangu"
        ) ~ "Japanese",
        str_detect(
          restaurant,
          "Malay|Rasa|Cik|Dapur|Rebung|Zakhir|Village Park|ADU|Warisan|Nasi|Dancing Fish|Sarang"
        ) ~ "Malay",
        str_detect(
          restaurant,
          "Kerala|India|Lanka|Malabar|Curry|Raju|Bhavan|Thosai|Tandoor|Bombay|Gem Restaurant|Nasi Kandar|NADODI|Qureshi|RSMY|Sangeetha|Nirwana|Asian Rice Pot|Masala|Annalakshmi|Aliyaa|MTR"
        ) ~ "South Asian",
        str_detect(restaurant, "Latino|Mexican") ~ "Latino",
        str_detect(
          restaurant,
          "Filipino|Bali|Vietnam|GOODDAM|Korea|Sao Nam|Naughty Nuri's"
        ) ~ "Other Asian",
        str_detect(
          restaurant,
          "Bistro|Deli|Secret Recipe|Tujo|Wild Sheep|Antipodean|Coffee|One Half|Blue Room|Awesome Canteen|Botanica|Chili's|Don's Diner|GravyBaby|Hornbill|Huck's|myBurgerLab|Naj & Belle|Tony Roma's|Louisiana|Cor Blimey|4Fingers|Bacon And Balls|POP PIZZA|After Black|Define:Food|Ashley's by Living Food|March Azalea Kitchen|Mighty Monster IPC|Organic Express|Sköhns Canteen|Table9|Rabbit Hole|Williams Corner|Tiki Taka"
        ) ~ "Casual Western",
        str_detect(restaurant, "Cafe|Grind|Café|Tujo|cafe") ~ "Cafe",
        str_detect(restaurant, "DC Restaurant|ZENZERO") ~ "Other Upmarket",
        str_detect(restaurant, "Seafood|Shell Out") ~ "Seafood",
        str_detect(
          restaurant,
          "Lounge|Bar|Decanter|Knowhere Bangsar|The Locker & Loft|Tom, Dick & Harry's|WET|The Enclave|Out of Africa"
        ) ~ "Bar",
        str_detect(restaurant, "Restoran|Restaurant") ~ "Chinese",
        TRUE ~ "Upmarket"
      )) 
}


google_reviews |> 
  group_by(restaurant) |> 
  summarise(review_count = n(),
            rating = mean(rating)) |> 
  ggplot(aes(x = review_count, 
             y = rating)) + 
  geom_point(alpha = .15) + 
  scale_x_log10(breaks = c(0, 10, 30, 100, 300, 1000), 
                labels = comma) + 
  labs(title = "Distribution of Google review counts and ratings per restaurant in Malaysia", 
       subtitle = "The limit for scraping reviews from Google Maps is around 300 per restaurant", 
       x = "Number of reviews", 
       y = "Mean rating")  +
  
  trip_reviews |> 
  group_by(restaurant) |> 
  summarise(reviews = n(), 
            rating = mean(rating)) |> 
  ggplot(aes(x = reviews, y = rating)) + 
  geom_point(alpha = .15) + 
  scale_x_log10(breaks = c(0, 10, 30, 100, 300, 1000), 
                labels = comma) + 
  labs(title = "Distribution of Trip Advisor review counts and ratings per restaurant in Malaysia", 
       subtitle = "The limit for scraping reviews from Google Maps is around 300 per restaurant", 
       x = "Number of reviews", 
       y = "Mean rating")

google_reviews_with_cuisine |> 
  filter(rating == 5 & str_detect(review, "free|FREE") & 
           !str_detect(review, "dairy-free|hassle free|butter free|Pork free|pork free|freeflow|Freeflow|free flow|sugar free|sugar-free|sugarfreefree delivery|Delivery was free|freez|free refill|Free refill|Fuss free|fuss free|free WiFI|Free WiFi|free wifi|Free wifi|noise free|noise-free|Noise free|Noise-free|guilt free|Guilt free|Smoker free|smoke free|Smoke free")) |> 
  sample_n(10) |> 
  pull(review)
glimpse()

google_kl_cuisine |> 
  mutate(count = 1) |> 
  group_by(cuisine) |> 
  summarise(as_tibble_row(
    quantile(rating), 
    .name_repair = \(x) paste0('q', parse_number(x))), 
    .groups = "drop") |> 
  rowwise() |> 
  mutate(sort = mean(c(q25, q50))) |> 
  arrange(desc(sort))


It appears that  

Are reviews useful? The commonality of five-star reviews indicate that the mean rating is more likely an indicator of expectations being met rather than any true excellence. 



These differences probably come down to the reviewers on Google and Trip Advisor and their respective purposes. Google reviewers are often locals or general consumers, whilst Trip Advisor reviewers tend to be travellers who have to provide more structured, specific reviews, leading to less casual reviews as there is a minimum word count required. 

# This is not really that useful, I will use bigrams instead
google_rating_words |> 
  distinct(rating, word, n) |>
  filter(n >= 20 & word %out% c(
    "food", "service", "restaurant", "taste", "kl", "price")
  ) |>  
  group_by(rating) |> 
  arrange(desc(n)) |> 
  slice(1:20) |>
  ggplot(aes(x = n, 
             y = reorder_within(str_sub(word, 1, 25), 
                                n, 
                                rating), 
             fill = factor(rating))) + 
  geom_col() + 
  scale_y_reordered() + 
  facet_wrap(~ rating, scales = "free") + 
  labs(title = "Most common words in Google review, by rating", 
       subtitle = 'Excludes "food", "service", "restaurant", "taste", "time", "kl", "price".'
  ) + 
  guides(fill = "none")

google_rating_words |> 
  inner_join(get_sentiments("nrc")) |> 
  group_by(sentiment, rating, rowid) |> 
  summarise(count = n_distinct(word), 
            .groups = "drop") |> 
  group_by(rating, sentiment) |> 
  summarise(reviews = n_distinct(rowid), 
            .groups = "drop") |> 
  group_by(rating) |> 
  mutate(sum = sum(reviews), 
         pc = reviews / sum) |> 
  ungroup() |> 
  mutate(sentiment = fct_relevel(sentiment, 
                                 c("surprise",
                                   "anticipation", 
                                   "joy", 
                                   "trust", 
                                   "positive", 
                                   "negative", 
                                   "sadness",
                                   "fear", 
                                   "anger", 
                                   "disgust"))) |> 
  ggplot(aes(x = pc, y = fct_rev(sentiment))) + 
  geom_col(aes(fill = sentiment)) + 
  scale_fill_manual(
    values =c(
      "anger" = "#780000", 
      "disgust" = "#c1121f", 
      "fear" = "#9e2a2b", 
      "negative" = "#bc4749", 
      "sadness" = "#b56576", 
      "anticipation" = "#90e0ef", 
      "joy" = "#00b4d8", 
      "surprise" = "#caf0f8", 
      "positive" = "#0077b6", 
      "trust" = "#118ab2"
    )
  ) +
  facet_wrap(~rating, scales = "free") + 
  scale_x_continuous(labels = percent) +
  guides(fill = "none") + 
  theme(strip.background = element_rect(fill = "black")) + 
  labs(title = "Breakdown of NRC sentiments in Google reviews by rating", 
       subtitle = "In the Klang Valley.", 
       y = "", 
       x = "")



trip_rating_words |> 
  inner_join(get_sentiments("nrc")) |> 
  group_by(sentiment, rating, rowid) |> 
  summarise(count = n_distinct(word), 
            .groups = "drop") |> 
  group_by(rating, sentiment) |> 
  summarise(reviews = n_distinct(rowid), 
            .groups = "drop") |> 
  group_by(rating) |> 
  mutate(sum = sum(reviews), 
         pc = reviews / sum) |> 
  ungroup() |> 
  mutate(sentiment = fct_relevel(sentiment, 
                                 c("surprise",
                                   "anticipation", 
                                   "joy", 
                                   "trust", 
                                   "positive", 
                                   "negative", 
                                   "sadness",
                                   "fear", 
                                   "anger", 
                                   "disgust"))) |> 
  ggplot(aes(x = pc, y = fct_rev(sentiment))) + 
  geom_col(aes(fill = sentiment)) + 
  scale_fill_manual(
    values =c(
      "anger" = "#780000", 
      "disgust" = "#c1121f", 
      "fear" = "#9e2a2b", 
      "negative" = "#bc4749", 
      "sadness" = "#b56576", 
      "anticipation" = "#90e0ef", 
      "joy" = "#00b4d8", 
      "surprise" = "#caf0f8", 
      "positive" = "#0077b6", 
      "trust" = "#118ab2"
    )
  ) +
  facet_wrap(~rating, scales = "free") + 
  scale_x_continuous(labels = percent) +
  guides(fill = "none") + 
  theme(strip.background = element_rect(fill = "black")) + 
  labs(title = "Breakdown of NRC sentiments in Trip Advisor reviews by rating", 
       subtitle = "In the Klang Valley.", 
       y = "", 
       x = "")
